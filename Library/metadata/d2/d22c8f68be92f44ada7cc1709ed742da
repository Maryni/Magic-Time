.WriteNewNinjaRule(name, args, description,
                                            is_cygwin, env, pool,
                                            depfile=depfile)

      inputs = [self.GypPathToNinja(i, env) for i in action['inputs']]
      if int(action.get('process_outputs_as_sources', False)):
        extra_sources += action['outputs']
      if int(action.get('process_outputs_as_mac_bundle_resources', False)):
        extra_mac_bundle_resources += action['outputs']
      outputs = [self.GypPathToNinja(o, env) for o in action['outputs']]

      # Then write out an edge using the rule.
      self.ninja.build(outputs, rule_name, inputs,
                       order_only=prebuild)
      all_outputs += outputs

      self.ninja.newline()

    return all_outputs

  def WriteRules(self, rules, extra_sources, prebuild,
                 mac_bundle_resources, extra_mac_bundle_resources):
    env = self.GetToolchainEnv()
    all_outputs = []
    for rule in rules:
      # Skip a rule with no action and no inputs.
      if 'action' not in rule and not rule.get('rule_sources', []):
        continue

      # First write out a rule for the rule action.
      name = '%s_%s' % (rule['rule_name'], self.hash_for_rules)

      args = rule['action']
      description = self.GenerateDescription(
          'RULE',
          rule.get('message', None),
          ('%s ' + generator_default_variables['RULE_INPUT_PATH']) % name)
      is_cygwin = (self.msvs_settings.IsRuleRunUnderCygwin(rule)
                   if self.flavor == 'win' else False)
      pool = 'console' if int(rule.get('ninja_use_console', 0)) else None
      rule_name, args = self.WriteNewNinjaRule(
          name, args, description, is_cygwin, env, pool)

      # TODO: if the command references the outputs directly, we should
      # simplify it to just use $out.

      # Rules can potentially make use of some special variables which
      # must vary per source file.
      # Compute the list of variables we'll need to provide.
      special_locals = ('source', 'root', 'dirname', 'ext', 'name')
      needed_variables = set(['source'])
      for argument in args:
        for var in special_locals:
          if '${%s}' % var in argument:
            needed_variables.add(var)

      def cygwin_munge(path):
        # pylint: disable=cell-var-from-loop
        if is_cygwin:
          return path.replace('\\', '/')
        return path

      inputs = [self.GypPathToNinja(i, env) for i in rule.get('inputs', [])]

      # If there are n source files matching the rule, and m additional rule
      # inputs, then adding 'inputs' to each build edge written below will
      # write m * n inputs. Collapsing reduces this to m + n.
      sources = rule.get('rule_sources', [])
      num_inputs = len(inputs)
      if prebuild:
        num_inputs += 1
      if num_inputs > 2 and len(sources) > 2:
        inputs = [self.WriteCollapsedDependencies(
          rule['rule_name'], inputs, order_only=prebuild)]
        prebuild = []

      # For each source file, write an edge that generates all the outputs.
      for source in sources:
        source = os.path.normpath(source)
        dirname, basename = os.path.split(source)
        root, ext = os.path.splitext(basename)

        # Gather the list of inputs and outputs, expanding $vars if possible.
        outputs = [self.ExpandRuleVariables(o, root, dirname,
                                            source, ext, basename)
                   for o in rule['outputs']]

        if int(rule.get('process_outputs_as_sources', False)):
          extra_sources += outputs

        was_mac_bundle_resource = source in mac_bundle_resources
        if was_mac_bundle_resource or \
            int(rule.get('process_outputs_as_mac_bundle_resources', False)):
          extra_mac_bundle_resources += outputs
          # Note: This is n_resources * n_outputs_in_rule.  Put to-be-removed
          # items in a set and remove them all in a single pass if this becomes
          # a performance issue.
          if was_mac_bundle_resource:
            mac_bundle_resources.remove(source)

        extra_bindings = []
        for var in needed_variables:
          if var == 'root':
            extra_bindings.append(('root', cygwin_munge(root)))
          elif var == 'dirname':
            # '$dirname' is a parameter to the rule action, which means
            # it shouldn't be converted to a Ninja path.  But we don't
            # want $!PRODUCT_DIR in there either.
            dirname_expanded = self.ExpandSpecial(dirname, self.base_to_build)
            extra_bindings.append(('dirname', cygwin_munge(dirname_expanded)))
          elif var == 'source':
            # '$source' is a parameter to the rule action, which means
            # it shouldn't be converted to a Ninja path.  But we don't
            # want $!PRODUCT_DIR in there either.
            source_expanded = self.ExpandSpecial(source, self.base_to_build)
            extra_bindings.append(('source', cygwin_munge(source_expanded)))
          elif var == 'ext':
            extra_bindings.append(('ext', ext))
          elif var == 'name':
            extra_bindings.append(('name', cygwin_munge(basename)))
          else:
            assert var == None, repr(var)

        outputs = [self.GypPathToNinja(o, env) for o in outputs]
        if self.flavor == 'win':
          # WriteNewNinjaRule uses unique_name for creating an rsp file on win.
          extra_bindings.append(('unique_name',
              hashlib.md5(outputs[0]).hexdigest()))
        self.ninja.build(outputs, rule_name, self.GypPathToNinja(source),
                         implicit=inputs,
                         order_only=prebuild,
                         variables=extra_bindings)

        all_outputs.extend(outputs)

    return all_outputs

  def WriteCopies(self, copies, prebuild, mac_bundle_depends):
    outputs = []
    env = self.GetToolchainEnv()
    for copy in copies:
      for path in copy['files']:
        # Normalize the path so trailing slashes don't confuse us.
        path = os.path.normpath(path)
        basename = os.path.split(path)[1]
        src = self.GypPathToNinja(path, env)
        dst = self.GypPathToNinja(os.path.join(copy['destination'], basename),
                                  env)
        outputs += self.ninja.build(dst, 'copy', src, order_only=prebuild)
        if self.is_mac_bundle:
          # gyp has mac_bundle_resources to copy things into a bundle's
          # Resources folder, but there's no built-in way to copy files to other
          # places in the bundle. Hence, some targets use copies for this. Check
          # if this file is copied into the current bundle, and if so add it to
          # the bundle depends so that dependent targets get rebuilt if the copy
          # input changes.
          if dst.startswith(self.xcode_settings.GetBundleContentsFolderPath()):
            mac_bundle_depends.append(dst)

    return outputs

  def WriteMacBundleResources(self, resources, bundle_depends):
    """Writes ninja edges for 'mac_bundle_resources'."""
    xcassets = []
    for output, res in gyp.xcode_emulation.GetMacBundleResources(
        generator_default_variables['PRODUCT_DIR'],
        self.xcode_settings, map(self.GypPathToNinja, resources)):
      output = self.ExpandSpecial(output)
      if os.path.splitext(output)[-1] != '.xcassets':
        isBinary = self.xcode_settings.IsBinaryOutputFormat(self.config_name)
        self.ninja.build(output, 'mac_tool', res,
                         variables=[('mactool_cmd', 'copy-bundle-resource'), \
                                    ('binary', isBinary)])
        bundle_depends.append(output)
      else:
        xcassets.append(res)
    return xcassets

  def WriteMacXCassets(self, xcassets, bundle_depends):
    """Writes ninja edges for 'mac_bundle_resources' .xcassets files.

    This add an invocation of 'actool' via the 'mac_tool.py' helper script.
    It assumes that the assets catalogs define at least one imageset and
    thus an Assets.car file will be generated in the application resources
    directory. If this is not the case, then the build will probably be done
    at each invocation of ninja."""
    if not xcassets:
      return

    extra_arguments = {}
    settings_to_arg = {
        'XCASSETS_APP_ICON': 'app-icon',
        'XCASSETS_LAUNCH_IMAGE': 'launch-image',
    }
    settings = self.xcode_settings.xcode_settings[self.config_name]
    for settings_key, arg_name in settings_to_arg.iteritems():
      value = settings.get(settings_key)
      if value:
        extra_arguments[arg_name] = value

    partial_info_plist = None
    if extra_arguments:
      partial_info_plist = self.GypPathToUniqueOutput(
          'assetcatalog_generated_info.plist')
      extra_arguments['output-partial-info-plist'] = partial_info_plist

    outputs = []
    outputs.append(
        os.path.join(
            self.xcode_settings.GetBundleResourceFolder(),
            'Assets.car'))
    if partial_info_plist:
      outputs.append(partial_info_plist)

    keys = QuoteShellArgument(json.dumps(extra_arguments), self.flavor)
    extra_env = self.xcode_settings.GetPerTargetSettings()
    env = self.GetSortedXcodeEnv(additional_settings=extra_env)
    env = self.ComputeExportEnvString(env)

    bundle_depends.extend(self.ninja.build(
        outputs, 'compile_xcassets', xcassets,
        variables=[('env', env), ('keys', keys)]))
    return partial_info_plist

  def WriteMacInfoPlist(self, partial_info_plist, bundle_depends):
    """Write build rules for bundle Info.plist files."""
    info_plist, out, defines, extra_env = gyp.xcode_emulation.GetMacInfoPlist(
        generator_default_variables['PRODUCT_DIR'],
        self.xcode_settings, self.GypPathToNinja)
    if not info_plist:
      return
    out = self.ExpandSpecial(out)
    if defines:
      # Create an intermediate file to store preprocessed results.
      intermediate_plist = self.GypPathToUniqueOutput(
          os.path.basename(info_plist))
      defines = ' '.join([Define(d, self.flavor) for d in defines])
      info_plist = self.ninja.build(
          intermediate_plist, 'preprocess_infoplist', info_plist,
          variables=[('defines',defines)])

    env = self.GetSortedXcodeEnv(additional_settings=extra_env)
    env = self.ComputeExportEnvString(env)

    if partial_info_plist:
      intermediate_plist = self.GypPathToUniqueOutput('merged_info.plist')
      info_plist = self.ninja.build(
          intermediate_plist, 'merge_infoplist',
          [partial_info_plist, info_plist])

    keys = self.xcode_settings.GetExtraPlistItems(self.config_name)
    keys = QuoteShellArgument(json.dumps(keys), self.flavor)
    isBinary = self.xcode_settings.IsBinaryOutputFormat(self.config_name)
    self.ninja.build(out, 'copy_infoplist', info_plist,
                     variables=[('env', env), ('keys', keys),
                                ('binary', isBinary)])
    bundle_depends.append(out)

  def WriteSources(self, ninja_file, config_name, config, sources, predepends,
                   precompiled_header, spec):
    """Write build rules to compile all of |sources|."""
    if self.toolset == 'host':
      self.ninja.variable('ar', '$ar_host')
      self.ninja.variable('cc', '$cc_host')
      self.ninja.variable('cxx', '$cxx_host')
      self.ninja.variable('ld', '$ld_host')
      self.ninja.variable('ldxx', '$ldxx_host')
      self.ninja.variable('nm', '$nm_host')
      self.ninja.variable('readelf', '$readelf_host')

    if self.flavor != 'mac' or len(self.archs) == 1:
      return self.WriteSourcesForArch(
          self.ninja, config_name, config, sources, predepends,
          precompiled_header, spec)
    else:
      return dict((arch, self.WriteSourcesForArch(
            self.arch_subninjas[arch], config_name, config, sources, predepends,
            precompiled_header, spec, arch=arch))
          for arch in self.archs)

  def WriteSourcesForArch(self, ninja_file, config_name, config, sources,
                          predepends, precompiled_header, spec, arch=None):
    """Write build rules to compile all of |sources|."""

    extra_defines = []
    if self.flavor == 'mac':
      cflags = self.xcode_settings.GetCflags(config_name, arch=arch)
      cflags_c = self.xcode_settings.GetCflagsC(config_name)
      cflags_cc = self.xcode_settings.GetCflagsCC(config_name)
      cflags_objc = ['$cflags_c'] + \
                    self.xcode_settings.GetCflagsObjC(config_name)
      cflags_objcc = ['$cflags_cc'] + \
                     self.xcode_settings.GetCflagsObjCC(config_name)
    elif self.flavor == 'win':
      asmflags = self.msvs_settings.GetAsmflags(config_name)
      cflags = self.msvs_settings.GetCflags(config_name)
      cflags_c = self.msvs_settings.GetCflagsC(config_name)
      cflags_cc = self.msvs_settings.GetCflagsCC(config_name)
      extra_defines = self.msvs_settings.GetComputedDefines(config_name)
      # See comment at cc_command for why there's two .pdb files.
      pdbpath_c = pdbpath_cc = self.msvs_settings.GetCompilerPdbName(
          config_name, self.ExpandSpecial)
      if not pdbpath_c:
        obj = 'obj'
        if self.toolset != 'target':
          obj += '.' + self.toolset
        pdbpath = os.path.normpath(os.path.join(obj, self.base_dir, self.name))
        pdbpath_c = pdbpath + '.c.pdb'
        pdbpath_cc = pdbpath + '.cc.pdb'
      self.WriteVariableList(ninja_file, 'pdbname_c', [pdbpath_c])
      self.WriteVariableList(ninja_file, 'pdbname_cc', [pdbpath_cc])
      self.WriteVariableList(ninja_file, 'pchprefix', [self.name])
    else:
      cflags = config.get('cflags', [])
      cflags_c = config.get('cflags_c', [])
      cflags_cc = config.get('cflags_cc', [])

    # Respect environment variables related to build, but target-specific
    # flags can still override them.
    if self.toolset == 'target':
      cflags_c = (os.environ.get('CPPFLAGS', '').split() +
                  os.environ.get('CFLAGS', '').split() + cflags_c)
      cflags_cc = (os.environ.get('CPPFLAGS', '').split() +
                   os.environ.get('CXXFLAGS', '').split() + cflags_cc)
    elif self.toolset == 'host':
      cflags_c = (os.environ.get('CPPFLAGS_host', '').split() +
                  os.environ.get('CFLAGS_host', '').split() + cflags_c)
      cflags_cc = (os.environ.get('CPPFLAGS_host', '').split() +
                   os.environ.get('CXXFLAGS_host', '').split() + cflags_cc)

    defines = config.get('defines', []) + extra_defines
    self.WriteVariableList(ninja_file, 'defines',
                           [Define(d, self.flavor) for d in defines])
    if self.flavor == 'win':
      self.WriteVariableList(ninja_file, 'asmflags',
                             map(self.ExpandSpecial, asmflags))
      self.WriteVariableList(ninja_file, 'rcflags',
          [QuoteShellArgument(self.ExpandSpecial(f), self.flavor)
           for f in self.msvs_settings.GetRcflags(config_name,
                                                  self.GypPathToNinja)])

    include_dirs = config.get('include_dirs', [])

    env = self.GetToolchainEnv()
    if self.flavor == 'win':
      include_dirs = self.msvs_settings.AdjustIncludeDirs(include_dirs,
                                                          config_name)
    self.WriteVariableList(ninja_file, 'includes',
        [QuoteShellArgument('-I' + self.GypPathToNinja(i, env), self.flavor)
         for i in include_dirs])

    if self.flavor == 'win':
      midl_include_dirs = config.get('midl_include_dirs', [])
      midl_include_dirs = self.msvs_settings.AdjustMidlIncludeDirs(
          midl_include_dirs, config_name)
      self.WriteVariableList(ninja_file, 'midl_includes',
          [QuoteShellArgument('-I' + self.GypPathToNinja(i, env), self.flavor)
           for i in midl_include_dirs])

    pch_commands = precompiled_header.GetPchBuildCommands(arch)
    if self.flavor == 'mac':
      # Most targets use no precompiled headers, so only write these if needed.
      for ext, var in [('c', 'cflags_pch_c'), ('cc', 'cflags_pch_cc'),
                       ('m', 'cflags_pch_objc'), ('mm', 'cflags_pch_objcc')]:
        include = precompiled_header.GetInclude(ext, arch)
        if include: ninja_file.variable(var, include)

    arflags = config.get('arflags', [])

    self.WriteVariableList(ninja_file, 'cflags',
                           map(self.ExpandSpecial, cflags))
    self.WriteVariableList(ninja_file, 'cflags_c',
                           map(self.ExpandSpecial, cflags_c))
    self.WriteVariableList(ninja_file, 'cflags_cc',
                           map(self.ExpandSpecial, cflags_cc))
    if self.flavor == 'mac':
      self.WriteVariableList(ninja_file, 'cflags_objc',
                             map(self.ExpandSpecial, cflags_objc))
      self.WriteVariableList(ninja_file, 'cflags_objcc',
                             map(self.ExpandSpecial, cflags_objcc))
    self.WriteVariableList(ninja_file, 'arflags',
                           map(self.ExpandSpecial, arflags))
    ninja_file.newline()
    outputs = []
    has_rc_source = False
    for source in sources:
      filename, ext = os.path.splitext(source)
      ext = ext[1:]
      obj_ext = self.obj_ext
      if ext in ('cc', 'cpp', 'cxx'):
        command = 'cxx'
        self.uses_cpp = True
      elif ext == 'c' or (ext == 'S' and self.flavor != 'win'):
        command = 'cc'
      elif ext == 's' and self.flavor != 'win':  # Doesn't generate .o.d files.
        command = 'cc_s'
      elif (self.flavor == 'win' and ext == 'asm' and
            not self.msvs_settings.HasExplicitAsmRules(spec)):
        command = 'asm'
        # Add the _asm suffix as msvs is capable of handling .cc and
        # .asm files of the same name without collision.
        obj_ext = '_asm.obj'
      elif self.flavor == 'mac' and ext == 'm':
        command = 'objc'
      elif self.flavor == 'mac' and ext == 'mm':
        command = 'objcxx'
        self.uses_cpp = True
      elif self.flavor == 'win' and ext == 'rc':
        command = 'rc'
        obj_ext = '.res'
        has_rc_source = True
      else:
        # Ignore unhandled extensions.
        continue
      input = self.GypPathToNinja(source)
      output = self.GypPathToUniqueOutput(filename + obj_ext)
      if arch is not None:
        output = AddArch(output, arch)
      implicit = precompiled_header.GetObjDependencies([input], [output], arch)
      variables = []
      if self.flavor == 'win':
        variables, output, implicit = precompiled_header.GetFlagsModifications(
            input, output, implicit, command, cflags_c, cflags_cc,
            self.ExpandSpecial)
      ninja_file.build(output, command, input,
                       implicit=[gch for _, _, gch in implicit],
                       order_only=predepends, variables=variables)
      outputs.append(output)

    if has_rc_source:
      resource_include_dirs = config.get('resource_include_dirs', include_dirs)
      self.WriteVariableList(ninja_file, 'resource_includes',
          [QuoteShellArgument('-I' + self.GypPathToNinja(i, env), self.flavor)
           for i in resource_include_dirs])

    self.WritePchTargets(ninja_file, pch_commands)

    ninja_file.newline()
    return outputs

  def WritePchTargets(self, ninja_file, pch_commands):
    """Writes ninja rules to compile prefix headers."""
    if not pch_commands:
      return

    for gch, lang_flag, lang, input in pch_commands:
      var_name = {
        'c': 'cflags_pch_c',
        'cc': 'cflags_pch_cc',
        'm': 'cflags_pch_objc',
        'mm': 'cflags_pch_objcc',
      }[lang]

      map = { 'c': 'cc', 'cc': 'cxx', 'm': 'objc', 'mm': 'objcxx', }
      cmd = map.get(lang)
      ninja_file.build(gch, cmd, input, variables=[(var_name, lang_flag)])

  def WriteLink(self, spec, config_name, config, link_deps):
    """Write out a link step. Fills out target.binary. """
    if self.flavor != 'mac' or len(self.archs) == 1:
      return self.WriteLinkForArch(
          self.ninja, spec, config_name, config, link_deps)
    else:
      output = self.ComputeOutput(spec)
      inputs = [self.WriteLinkForArch(self.arch_subninjas[arch], spec,
                                      config_name, config, link_deps[arch],
                                      arch=arch)
                for arch in self.archs]
      extra_bindings = []
      build_output = output
      if not self.is_mac_bundle:
        self.AppendPostbuildVariable(extra_bindings, spec, output, output)

      # TODO(yyanagisawa): more work needed to fix:
      # https://code.google.com/p/gyp/issues/detail?id=411
      if (spec['type'] in ('shared_library', 'loadable_module') and
          not self.is_mac_bundle):
        extra_bindings.append(('lib', output))
        self.ninja.build([output, output + '.TOC'], 'solipo', inputs,
            variables=extra_bindings)
      else:
        self.ninja.build(build_output, 'lipo', inputs, variables=extra_bindings)
      return output

  def WriteLinkForArch(self, ninja_file, spec, config_name, config,
                       link_deps, arch=None):
    """Write out a link step. Fills out target.binary. """
    command = {
      'executable':      'link',
      'loadable_module': 'solink_module',
      'shared_library':  'solink',
    }[spec['type']]
    command_suffix = ''

    implicit_deps = set()
    solibs = set()
    order_deps = set()

    if 'dependencies' in spec:
      # Two kinds of dependencies:
      # - Linkable dependencies (like a .a or a .so): add them to the link line.
      # - Non-linkable dependencies (like a rule that generates a file
      #   and writes a stamp file): add them to implicit_deps
      extra_link_deps = set()
      for dep in spec['dependencies']:
        target = self.target_outputs.get(dep)
        if not target:
          continue
        linkable = target.Linkable()
        if linkable:
          new_deps = []
          if (self.flavor == 'win' and
              target.component_objs and
              self.msvs_settings.IsUseLibraryDependencyInputs(config_name)):
            new_deps = target.component_objs
            if target.compile_deps:
              order_deps.add(target.compile_deps)
          elif self.flavor == 'win' and target.import_lib:
            new_deps = [target.import_lib]
          elif target.UsesToc(self.flavor):
            solibs.add(target.binary)
            implicit_deps.add(target.binary + '.TOC')
          else:
            new_deps = [target.binary]
          for new_dep in new_deps:
            if new_dep not in extra_link_deps:
              extra_link_deps.add(new_dep)
              link_deps.append(new_dep)

        final_output = target.FinalOutput()
        if not linkable or final_output != target.binary:
          implicit_deps.add(final_output)

    extra_bindings = []
    if self.uses_cpp and self.flavor != 'win':
      extra_bindings.append(('ld', '$ldxx'))

    output = self.ComputeOutput(spec, arch)
    if arch is None and not self.is_mac_bundle:
      self.AppendPostbuildVariable(extra_bindings, spec, output, output)

    is_executable = spec['type'] == 'executable'
    # The ldflags config key is not used on mac or win. On those platforms
    # linker flags are set via xcode_settings and msvs_settings, respectively.
    env_ldflags = os.environ.get('LDFLAGS', '').split()
    if self.flavor == 'mac':
      ldflags = self.xcode_settings.GetLdflags(config_name,
          self.ExpandSpecial(generator_default_variables['PRODUCT_DIR']),
          self.GypPathToNinja, arch)
      ldflags = env_ldflags + ldflags
    elif self.flavor == 'win':
      manifest_base_name = self.GypPathToUniqueOutput(
          self.ComputeOutputFileName(spec))
      ldflags, intermediate_manifest, manifest_files = \
          self.msvs_settings.GetLdflags(config_name, self.GypPathToNinja,
                                        self.ExpandSpecial, manifest_base_name,
                                        output, is_executable,
                                        self.toplevel_build)
      ldflags = env_ldflags + ldflags
      self.WriteVariableList(ninja_file, 'manifests', manifest_files)
      implicit_deps = implicit_deps.union(manifest_files)
      if intermediate_manifest:
        self.WriteVariableList(
            ninja_file, 'intermediatemanifest', [intermediate_manifest])
      command_suffix = _GetWinLinkRuleNameSuffix(
          self.msvs_settings.IsEmbedManifest(config_name))
      def_file = self.msvs_settings.GetDefFile(self.GypPathToNinja)
      if def_file:
        implicit_deps.add(def_file)
    else:
      # Respect environment variables related to build, but target-specific
      # flags can still override them.
      ldflags = env_ldflags + config.get('ldflags', [])
      if is_executable and len(solibs):
        rpath = 'lib/'
        if self.toolset != 'target':
          rpath += self.toolset
        ldflags.append(r'-Wl,-rpath=\$$ORIGIN/%s' % rpath)
        ldflags.append('-Wl,-rpath-link=%s' % rpath)
    self.WriteVariableList(ninja_file, 'ldflags',
                           map(self.ExpandSpecial, ldflags))

    library_dirs = config.get('library_dirs', [])
    if self.flavor == 'win':
      library_dirs = [self.msvs_settings.ConvertVSMacros(l, config_name)
                      for l in library_dirs]
      library_dirs = ['/LIBPATH:' + QuoteShellArgument(self.GypPathToNinja(l),
                                                       self.flavor)
                      for l in library_dirs]
    else:
      library_dirs = [QuoteShellArgument('-L' + self.GypPathToNinja(l),
                                         self.flavor)
                      for l in library_dirs]

    libraries = gyp.common.uniquer(map(self.ExpandSpecial,
                                       spec.get('libraries', [])))
    if self.flavor == 'mac':
      libraries = self.xcode_settings.AdjustLibraries(libraries, config_name)
    elif self.flavor == 'win':
      libraries = self.msvs_settings.AdjustLibraries(libraries)

    self.WriteVariableList(ninja_file, 'libs', library_dirs + libraries)

    linked_binary = output

    if command in ('solink', 'solink_module'):
      extra_bindings.append(('soname', os.path.split(output)[1]))
      extra_bindings.append(('lib',
                            gyp.common.EncodePOSIXShellArgument(output)))
      if self.flavor != 'win':
        link_file_list = output
        if self.is_mac_bundle:
          # 'Dependency Framework.framework/Versions/A/Dependency Framework' ->
          # 'Dependency Framework.framework.rsp'
          link_file_list = self.xcode_settings.GetWrapperName()
        if arch:
          link_file_list += '.' + arch
        link_file_list += '.rsp'
        # If an rspfile contains spaces, ninja surrounds the filename with
        # quotes around it and then passes it to open(), creating a file with
        # quotes in its name (and when looking for the rsp file, the name
        # makes it through bash which strips the quotes) :-/
        link_file_list = link_file_list.replace(' ', '_')
        extra_bindings.append(
          ('link_file_list',
            gyp.common.EncodePOSIXShellArgument(link_file_list)))
      if self.flavor == 'win':
        extra_bindings.append(('binary', output))
        if ('/NOENTRY' not in ldflags and
            not self.msvs_settings.GetNoImportLibrary(config_name)):
          self.target.import_lib = output + '.lib'
          extra_bindings.append(('implibflag',
                                 '/IMPLIB:%s' % self.target.import_lib))
          pdbname = self.msvs_settings.GetPDBName(
              config_name, self.ExpandSpecial, output + '.pdb')
          output = [output, self.target.import_lib]
          if pdbname:
            output.append(pdbname)
      elif not self.is_mac_bundle:
        output = [output, output + '.TOC']
      else:
        command = command + '_notoc'
    elif self.flavor == 'win':
      extra_bindings.append(('binary', output))
      pdbname = self.msvs_settings.GetPDBName(
          config_name, self.ExpandSpecial, output + '.pdb')
      if pdbname:
        output = [output, pdbname]


    if len(solibs):
      extra_bindings.append(('solibs', gyp.common.EncodePOSIXShellList(solibs)))

    ninja_file.build(output, command + command_suffix, link_deps,
                     implicit=list(implicit_deps),
                     order_only=list(order_deps),
                     variables=extra_bindings)
    return linked_binary

  def WriteTarget(self, spec, config_name, config, link_deps, compile_deps):
    extra_link_deps = any(self.target_outputs.get(dep).Linkable()
                          for dep in spec.get('dependencies', [])
                          if dep in self.target_outputs)
    if spec['type'] == 'none' or (not link_deps and not extra_link_deps):
      # TODO(evan): don't call this function for 'none' target types, as
      # it doesn't do anything, and we fake out a 'binary' with a stamp file.
      self.target.binary = compile_deps
      self.target.type = 'none'
    elif spec['type'] == 'static_library':
      self.target.binary = self.ComputeOutput(spec)
      if (self.flavor not in ('mac', 'openbsd', 'netbsd', 'win') and not
          self.is_standalone_static_library):
        self.ninja.build(self.target.binary, 'alink_thin', link_deps,
                         order_only=compile_deps)
      else:
        variables = []
        if self.xcode_settings:
          libtool_flags = self.xcode_settings.GetLibtoolflags(config_name)
          if libtool_flags:
            variables.append(('libtool_flags', libtool_flags))
        if self.msvs_settings:
          libflags = self.msvs_settings.GetLibFlags(config_name,
                                                    self.GypPathToNinja)
          variables.append(('libflags', libflags))

        if self.flavor != 'mac' or len(self.archs) == 1:
          self.AppendPostbuildVariable(variables, spec,
                                       self.target.binary, self.target.binary)
          self.ninja.build(self.target.binary, 'alink', link_deps,
                           order_only=compile_deps, variables=variables)
        else:
          inputs = []
          for arch in self.archs:
            output = self.ComputeOutput(spec, arch)
            self.arch_subninjas[arch].build(output, 'alink', link_deps[arch],
                                            order_only=compile_deps,
                                            variables=variables)
            inputs.append(output)
          # TODO: It's not clear if libtool_flags should be passed to the alink
          # call that combines single-arch .a files into a fat .a file.
          self.AppendPostbuildVariable(variables, spec,
                                       self.target.binary, self.target.binary)
          self.ninja.build(self.target.binary, 'alink', inputs,
                           # FIXME: test proving order_only=compile_deps isn't
                           # needed.
                           variables=variables)
    else:
      self.target.binary = self.WriteLink(spec, config_name, config, link_deps)
    return self.target.binary

  def WriteMacBundle(self, spec, mac_bundle_depends, is_empty):
    assert self.is_mac_bundle
    package_framework = spec['type'] in ('shared_library', 'loadable_module')
    output = self.ComputeMacBundleOutput()
    if is_empty:
      output += '.stamp'
    variables = []
    self.AppendPostbuildVariable(variables, spec, output, self.target.binary,
                                 is_command_start=not package_framework)
    if package_framework and not is_empty:
      variables.append(('version', self.xcode_settings.GetFrameworkVersion()))
      self.ninja.build(output, 'package_framework', mac_bundle_depends,
                       variables=variables)
    else:
      self.ninja.build(output, 'stamp', mac_bundle_depends,
                       variables=variables)
    self.target.bundle = output
    return output

  def GetToolchainEnv(self, additional_settings=None):
    """Returns the variables toolchain would set for build steps."""
    env = self.GetSortedXcodeEnv(additional_settings=additional_settings)
    if self.flavor == 'win':
      env = self.GetMsvsToolchainEnv(
          additional_settings=additional_settings)
    return env

  def GetMsvsToolchainEnv(self, additional_settings=None):
    """Returns the variables Visual Studio would set for build steps."""
    return self.msvs_settings.GetVSMacroEnv('$!PRODUCT_DIR',
                                             config=self.config_name)

  def GetSortedXcodeEnv(self, additional_settings=None):
    """Returns the variables Xcode would set for build steps."""
    assert self.abs_build_dir
    abs_build_dir = self.abs_build_dir
    return gyp.xcode_emulation.GetSortedXcodeEnv(
        self.xcode_settings, abs_build_dir,
        os.path.join(abs_build_dir, self.build_to_base), self.config_name,
        additional_settings)

  def GetSortedXcodePostbuildEnv(self):
    """Returns the variables Xcode would set for postbuild steps."""
    postbuild_settings = {}
    # CHROMIUM_STRIP_SAVE_FILE is a chromium-specific hack.
    # TODO(thakis): It would be nice to have some general mechanism instead.
    strip_save_file = self.xcode_settings.GetPerTargetSetting(
        'CHROMIUM_STRIP_SAVE_FILE')
    if strip_save_file:
      postbuild_settings['CHROMIUM_STRIP_SAVE_FILE'] = strip_save_file
    return self.GetSortedXcodeEnv(additional_settings=postbuild_settings)

  def AppendPostbuildVariable(self, variables, spec, output, binary,
                              is_command_start=False):
    """Adds a 'postbuild' variable if there is a postbuild for |output|."""
    postbuild = self.GetPostbuildCommand(spec, output, binary, is_command_start)
    if postbuild:
      variables.append(('postbuilds', postbuild))

  def GetPostbuildCommand(self, spec, output, output_binary, is_command_start):
    """Returns a shell command that runs all the postbuilds, and removes
    |output| if any of them fails. If |is_command_start| is False, then the
    returned string will start with ' && '."""
    if not self.xcode_settings or spec['type'] == 'none' or not output:
      return ''
    output = QuoteShellArgument(output, self.flavor)
    postbuilds = gyp.xcode_emulation.GetSpecPostbuildCommands(spec, quiet=True)
    if output_binary is not None:
      postbuilds = self.xcode_settings.AddImplicitPostbuilds(
          self.config_name,
          os.path.normpath(os.path.join(self.base_to_build, output)),
          QuoteShellArgument(
              os.path.normpath(os.path.join(self.base_to_build, output_binary)),
              self.flavor),
          postbuilds, quiet=True)

    if not postbuilds:
      return ''
    # Postbuilds expect to be run in the gyp file's directory, so insert an
    # implicit postbuild to cd to there.
    postbuilds.insert(0, gyp.common.EncodePOSIXShellList(
        ['cd', self.build_to_base]))
    env = self.ComputeExportEnvString(self.GetSortedXcodePostbuildEnv())
    # G will be non-null if any postbuild fails. Run all postbuilds in a
    # subshell.
    commands = env + ' (' + \
        ' && '.join([ninja_syntax.escape(command) for command in postbuilds])
    command_string = (commands + '); G=$$?; '
                      # Remove the final output if any postbuild failed.
                      '((exit $$G) || rm -rf %s) ' % output + '&& exit $$G)')
    if is_command_start:
      return '(' + command_string + ' && '
    else:
      return '$ && (' + command_string

  def ComputeExportEnvString(self, env):
    """Given an environment, returns a string looking like
        'export FOO=foo; export BAR="${FOO} bar;'
    that exports |env| to the shell."""
    export_str = []
    for k, v in env:
      export_str.append('export %s=%s;' %
          (k, ninja_syntax.escape(gyp.common.EncodePOSIXShellArgument(v))))
    return ' '.join(export_str)

  def ComputeMacBundleOutput(self):
    """Return the 'output' (full output path) to a bundle output directory."""
    assert self.is_mac_bundle
    path = generator_default_variables['PRODUCT_DIR']
    return self.ExpandSpecial(
        os.path.join(path, self.xcode_settings.GetWrapperName()))

  def ComputeOutputFileName(self, spec, type=None):
    """Compute the filename of the final output for the current target."""
    if not type:
      type = spec['type']

    default_variables = copy.copy(generator_default_variables)
    CalculateVariables(default_variables, {'flavor': self.flavor})

    # Compute filename prefix: the product prefix, or a default for
    # the product type.
    DEFAULT_PREFIX = {
      'loadable_module': default_variables['SHARED_LIB_PREFIX'],
      'shared_library': default_variables['SHARED_LIB_PREFIX'],
      'static_library': default_variables['STATIC_LIB_PREFIX'],
      'executable': default_variables['EXECUTABLE_PREFIX'],
      }
    prefix = spec.get('product_prefix', DEFAULT_PREFIX.get(type, ''))

    # Compute filename extension: the product extension, or a default
    # for the product type.
    DEFAULT_EXTENSION = {
        'loadable_module': default_variables['SHARED_LIB_SUFFIX'],
        'shared_library': default_variables['SHARED_LIB_SUFFIX'],
        'static_library': default_variables['STATIC_LIB_SUFFIX'],
        'executable': default_variables['EXECUTABLE_SUFFIX'],
      }
    extension = spec.get('product_extension')
    if extension:
      extension = '.' + extension
    else:
      extension = DEFAULT_EXTENSION.get(type, '')

    if 'product_name' in spec:
      # If we were given an explicit name, use that.
      target = spec['product_name']
    else:
      # Otherwise, derive a name from the target name.
      target = spec['target_name']
      if prefix == 'lib':
        # Snip out an extra 'lib' from libs if appropriate.
        target = StripPrefix(target, 'lib')

    if type in ('static_library', 'loadable_module', 'shared_library',
                        'executable'):
      return '%s%s%s' % (prefix, target, extension)
    elif type == 'none':
      return '%s.stamp' % target
    else:
      raise Exception('Unhandled output type %s' % type)

  def ComputeOutput(self, spec, arch=None):
    """Compute the path for the final output of the spec."""
    type = spec['type']

    if self.flavor == 'win':
      override = self.msvs_settings.GetOutputName(self.config_name,
                                                  self.ExpandSpecial)
      if override:
        return override

    if arch is None and self.flavor == 'mac' and type in (
        'static_library', 'executable', 'shared_library', 'loadable_module'):
      filename = self.xcode_settings.GetExecutablePath()
    else:
      filename = self.ComputeOutputFileName(spec, type)

    if arch is None and 'product_dir' in spec:
      path = os.path.join(spec['product_dir'], filename)
      return self.ExpandSpecial(path)

    # Some products go into the output root, libraries go into shared library
    # dir, and everything else goes into the normal place.
    type_in_output_root = ['executable', 'loadable_module']
    if self.flavor == 'mac' and self.toolset == 'target':
      type_in_output_root += ['shared_library', 'static_library']
    elif self.flavor == 'win' and self.toolset == 'target':
      type_in_output_root += ['shared_library']

    if arch is not None:
      # Make sure partial executables don't end up in a bundle or the regular
      # output directory.
      archdir = 'arch'
      if self.toolset != 'target':
        archdir = os.path.join('arch', '%s' % self.toolset)
      return os.path.join(archdir, AddArch(filename, arch))
    elif type in type_in_output_root or self.is_standalone_static_library:
      return filename
    elif type == 'shared_library':
      libdir = 'lib'
      if self.toolset != 'target':
        libdir = os.path.join('lib', '%s' % self.toolset)
      return os.path.join(libdir, filename)
    else:
      return self.GypPathToUniqueOutput(filename, qualified=False)

  def WriteVariableList(self, ninja_file, var, values):
    assert not isinstance(values, str)
    if values is None:
      values = []
    ninja_file.variable(var, ' '.join(values))

  def WriteNewNinjaRule(self, name, args, description, is_cygwin, env, pool,
                        depfile=None):
    """Write out a new ninja "rule" statement for a given command.

    Returns the name of the new rule, and a copy of |args| with variables
    expanded."""

    if self.flavor == 'win':
      args = [self.msvs_settings.ConvertVSMacros(
                  arg, self.base_to_build, config=self.config_name)
              for arg in args]
      description = self.msvs_settings.ConvertVSMacros(
          description, config=self.config_name)
    elif self.flavor == 'mac':
      # |env| is an empty list on non-mac.
      args = [gyp.xcode_emulation.ExpandEnvVars(arg, env) for arg in args]
      description = gyp.xcode_emulation.ExpandEnvVars(description, env)

    # TODO: we shouldn't need to qualify names; we do it because
    # currently the ninja rule namespace is global, but it really
    # should be scoped to the subninja.
    rule_name = self.name
    if self.toolset == 'target':
      rule_name += '.' + self.toolset
    rule_name += '.' + name
    rule_name = re.sub('[^a-zA-Z0-9_]', '_', rule_name)

    # Remove variable references, but not if they refer to the magic rule
    # variables.  This is not quite right, as it also protects these for
    # actions, not just for rules where they are valid. Good enough.
    protect = [ '${root}', '${dirname}', '${source}', '${ext}', '${name}' ]
    protect = '(?!' + '|'.join(map(re.escape, protect)) + ')'
    description = re.sub(protect + r'\$', '_', description)

    # gyp dictates that commands are run from the base directory.
    # cd into the directory before running, and adjust paths in
    # the arguments to point to the proper locations.
    rspfile = None
    rspfile_content = None
    args = [self.ExpandSpecial(arg, self.base_to_build) for arg in args]
    if self.flavor == 'win':
      rspfile = rule_name + '.$unique_name.rsp'
      # The cygwin case handles this inside the bash sub-shell.
      run_in = '' if is_cygwin else ' ' + self.build_to_base
      if is_cygwin:
        rspfile_content = self.msvs_settings.BuildCygwinBashCommandLine(
            args, self.build_to_base)
      else:
        rspfile_content = gyp.msvs_emulation.EncodeRspFileList(args)
      command = ('%s gyp-win-tool action-wrapper $arch ' % sys.executable +
                 rspfile + run_in)
    else:
      env = self.ComputeExportEnvString(env)
      command = gyp.common.EncodePOSIXShellList(args)
      command = 'cd %s; ' % self.build_to_base + env + command

    # GYP rules/actions express being no-ops by not touching their outputs.
    # Avoid executing downstream dependencies in this case by specifying
    # restat=1 to ninja.
    self.ninja.rule(rule_name, command, description, depfile=depfile,
                    restat=True, pool=pool,
                    rspfile=rspfile, rspfile_content=rspfile_content)
    self.ninja.newline()

    return rule_name, args


def CalculateVariables(default_variables, params):
  """Calculate additional variables for use in the build (called by gyp)."""
  global generator_additional_non_configuration_keys
  global generator_additional_path_sections
  flavor = gyp.common.GetFlavor(params)
  if flavor == 'mac':
    default_variables.setdefault('OS', 'mac')
    default_variables.setdefault('SHARED_LIB_SUFFIX', '.dylib')
    default_variables.setdefault('SHARED_LIB_DIR',
                                 generator_default_variables['PRODUCT_DIR'])
    default_variables.setdefault('LIB_DIR',
                                 generator_default_variables['PRODUCT_DIR'])

    # Copy additional generator configuration data from Xcode, which is shared
    # by the Mac Ninja generator.
    import gyp.generator.xcode as xcode_generator
    generator_additional_non_configuration_keys = getattr(xcode_generator,
        'generator_additional_non_configuration_keys', [])
    generator_additional_path_sections = getattr(xcode_generator,
        'generator_additional_path_sections', [])
    global generator_extra_sources_for_rules
    generator_extra_sources_for_rules = getattr(xcode_generator,
        'generator_extra_sources_for_rules', [])
  elif flavor == 'win':
    exts = gyp.MSVSUtil.TARGET_TYPE_EXT
    default_variables.setdefault('OS', 'win')
    default_variables['EXECUTABLE_SUFFIX'] = '.' + exts['executable']
    default_variables['STATIC_LIB_PREFIX'] = ''
    default_variables['STATIC_LIB_SUFFIX'] = '.' + exts['static_library']
    default_variables['SHARED_LIB_PREFIX'] = ''
    default_variables['SHARED_LIB_SUFFIX'] = '.' + exts['shared_library']

    # Copy additional generator configuration data from VS, which is shared
    # by the Windows Ninja generator.
    import gyp.generator.msvs as msvs_generator
    generator_additional_non_configuration_keys = getattr(msvs_generator,
        'generator_additional_non_configuration_keys', [])
    generator_additional_path_sections = getattr(msvs_generator,
        'generator_additional_path_sections', [])

    gyp.msvs_emulation.CalculateCommonVariables(default_variables, params)
  else:
    operating_system = flavor
    if flavor == 'android':
      operating_system = 'linux'  # Keep this legacy behavior for now.
    default_variables.setdefault('OS', operating_system)
    default_variables.setdefault('SHARED_LIB_SUFFIX', '.so')
    default_variables.setdefault('SHARED_LIB_DIR',
                                 os.path.join('$!PRODUCT_DIR', 'lib'))
    default_variables.setdefault('LIB_DIR',
                                 os.path.join('$!PRODUCT_DIR', 'obj'))

def ComputeOutputDir(params):
  """Returns the path from the toplevel_dir to the build output directory."""
  # generator_dir: relative path from pwd to where make puts build files.
  # Makes migrating from make to ninja easier, ninja doesn't put anything here.
  generator_dir = os.path.relpath(params['options'].generator_output or '.')

  # output_dir: relative path from generator_dir to the build directory.
  output_dir = params.get('generator_flags', {}).get('output_dir', 'out')

  # Relative path from source root to our output files.  e.g. "out"
  return os.path.normpath(os.path.join(generator_dir, output_dir))


def CalculateGeneratorInputInfo(params):
  """Called by __init__ to initialize generator values based on params."""
  # E.g. "out/gypfiles"
  toplevel = params['options'].toplevel_dir
  qualified_out_dir = os.path.normpath(os.path.join(
      toplevel, ComputeOutputDir(params), 'gypfiles'))

  global generator_filelist_paths
  generator_filelist_paths = {
      'toplevel': toplevel,
      'qualified_out_dir': qualified_out_dir,
  }


def OpenOutput(path, mode='w'):
  """Open |path| for writing, creating directories if necessary."""
  gyp.common.EnsureDirExists(path)
  return open(path, mode)


def CommandWithWrapper(cmd, wrappers, prog):
  wrapper = wrappers.get(cmd, '')
  if wrapper:
    return wrapper + ' ' + prog
  return prog


def GetDefaultConcurrentLinks():
  """Returns a best-guess for a number of concurrent links."""
  pool_size = int(os.environ.get('GYP_LINK_CONCURRENCY', 0))
  if pool_size:
    return pool_size

  if sys.platform in ('win32', 'cygwin'):
    import ctypes

    class MEMORYSTATUSEX(ctypes.Structure):
      _fields_ = [
        ("dwLength", ctypes.c_ulong),
        ("dwMemoryLoad", ctypes.c_ulong),
        ("ullTotalPhys", ctypes.c_ulonglong),
        ("ullAvailPhys", ctypes.c_ulonglong),
        ("ullTotalPageFile", ctypes.c_ulonglong),
        ("ullAvailPageFile", ctypes.c_ulonglong),
        ("ullTotalVirtual", ctypes.c_ulonglong),
        ("ullAvailVirtual", ctypes.c_ulonglong),
        ("sullAvailExtendedVirtual", ctypes.c_ulonglong),
      ]

    stat = MEMORYSTATUSEX()
    stat.dwLength = ctypes.sizeof(stat)
    ctypes.windll.kernel32.GlobalMemoryStatusEx(ctypes.byref(stat))

    # VS 2015 uses 20% more working set than VS 2013 and can consume all RAM
    # on a 64 GB machine.
    mem_limit = max(1, stat.ullTotalPhys / (5 * (2 ** 30)))  # total / 5GB
    hard_cap = max(1, int(os.environ.get('GYP_LINK_CONCURRENCY_MAX', 2**32)))
    return min(mem_limit, hard_cap)
  elif sys.platform.startswith('linux'):
    if os.path.exists("/proc/meminfo"):
      with open("/proc/meminfo") as meminfo:
        memtotal_re = re.compile(r'^MemTotal:\s*(\d*)\s*kB')
        for line in meminfo:
          match = memtotal_re.match(line)
          if not match:
            continue
          # Allow 8Gb per link on Linux because Gold is quite memory hungry
          return max(1, int(match.group(1)) / (8 * (2 ** 20)))
    return 1
  elif sys.platform == 'darwin':
    try:
      avail_bytes = int(subprocess.check_output(['sysctl', '-n', 'hw.memsize']))
      # A static library debug build of Chromium's unit_tests takes ~2.7GB, so
      # 4GB per ld process allows for some more bloat.
      return max(1, avail_bytes / (4 * (2 ** 30)))  # total / 4GB
    except:
      return 1
  else:
    # TODO(scottmg): Implement this for other platforms.
    return 1


def _GetWinLinkRuleNameSuffix(embed_manifest):
  """Returns the suffix used to select an appropriate linking rule depending on
  whether the manifest embedding is enabled."""
  return '_embed' if embed_manifest else ''


def _AddWinLinkRules(master_ninja, embed_manifest):
  """Adds link rules for Windows platform to |master_ninja|."""
  def FullLinkCommand(ldcmd, out, binary_type):
    resource_name = {
      'exe': '1',
      'dll': '2',
    }[binary_type]
    return '%(python)s gyp-win-tool link-with-manifests $arch %(embed)s ' \
           '%(out)s "%(ldcmd)s" %(resname)s $mt $rc "$intermediatemanifest" ' \
           '$manifests' % {
               'python': sys.executable,
               'out': out,
               'ldcmd': ldcmd,
               'resname': resource_name,
               'embed': embed_manifest }
  rule_name_suffix = _GetWinLinkRuleNameSuffix(embed_manifest)
  use_separate_mspdbsrv = (
      int(os.environ.get('GYP_USE_SEPARATE_MSPDBSRV', '0')) != 0)
  dlldesc = 'LINK%s(DLL) $binary' % rule_name_suffix.upper()
  dllcmd = ('%s gyp-win-tool link-wrapper $arch %s '
            '$ld /nologo $implibflag /DLL /OUT:$binary '
            '@$binary.rsp' % (sys.executable, use_separate_mspdbsrv))
  dllcmd = FullLinkCommand(dllcmd, '$binary', 'dll')
  master_ninja.rule('solink' + rule_name_suffix,
                    description=dlldesc, command=dllcmd,
                    rspfile='$binary.rsp',
                    rspfile_content='$libs $in_newline $ldflags',
                    restat=True,
                    pool='link_pool')
  master_ninja.rule('solink_module' + rule_name_suffix,
                    description=dlldesc, command=dllcmd,
                    rspfile='$binary.rsp',
                    rspfile_content='$libs $in_newline $ldflags',
                    restat=True,
                    pool='link_pool')
  # Note that ldflags goes at the end so that it has the option of
  # overriding default settings earlier in the command line.
  exe_cmd = ('%s gyp-win-tool link-wrapper $arch %s '
             '$ld /nologo /OUT:$binary @$binary.rsp' %
              (sys.executable, use_separate_mspdbsrv))
  exe_cmd = FullLinkCommand(exe_cmd, '$binary', 'exe')
  master_ninja.rule('link' + rule_name_suffix,
                    description='LINK%s $binary' % rule_name_suffix.upper(),
                    command=exe_cmd,
                    rspfile='$binary.rsp',
                    rspfile_content='$in_newline $libs $ldflags',
                    pool='link_pool')


def GenerateOutputForConfig(target_list, target_dicts, data, params,
                            config_name):
  options = params['options']
  flavor = gyp.common.GetFlavor(params)
  generator_flags = params.get('generator_flags', {})

  # build_dir: relative path from source root to our output files.
  # e.g. "out/Debug"
  build_dir = os.path.normpath(
      os.path.join(ComputeOutputDir(params), config_name))

  toplevel_build = os.path.join(options.toplevel_dir, build_dir)

  master_ninja_file = OpenOutput(os.path.join(toplevel_build, 'build.ninja'))
  master_ninja = ninja_syntax.Writer(master_ninja_file, width=120)

  # Put build-time support tools in out/{config_name}.
  gyp.common.CopyTool(flavor, toplevel_build)

  # Grab make settings for CC/CXX.
  # The rules are
  # - The priority from low to high is gcc/g++, the 'make_global_settings' in
  #   gyp, the environment variable.
  # - If there is no 'make_global_settings' for CC.host/CXX.host or
  #   'CC_host'/'CXX_host' enviroment variable, cc_host/cxx_host should be set
  #   to cc/cxx.
  if flavor == 'win':
    ar = 'lib.exe'
    # cc and cxx must be set to the correct architecture by overriding with one
    # of cl_x86 or cl_x64 below.
    cc = 'UNSET'
    cxx = 'UNSET'
    ld = 'link.exe'
    ld_host = '$ld'
  else:
    ar = 'ar'
    cc = 'cc'
    cxx = 'c++'
    ld = '$cc'
    ldxx = '$cxx'
    ld_host = '$cc_host'
    ldxx_host = '$cxx_host'

  ar_host = 'ar'
  cc_host = None
  cxx_host = None
  cc_host_global_setting = None
  cxx_host_global_setting = None
  clang_cl = None
  nm = 'nm'
  nm_host = 'nm'
  readelf = 'readelf'
  readelf_host = 'readelf'

  build_file, _, _ = gyp.common.ParseQualifiedTarget(target_list[0])
  make_global_settings = data[build_file].get('make_global_settings', [])
  build_to_root = gyp.common.InvertRelativePath(build_dir,
                                                options.toplevel_dir)
  wrappers = {}
  for key, value in make_global_settings:
    if key == 'AR':
      ar = os.path.join(build_to_root, value)
    if key == 'AR.host':
      ar_host = os.path.join(build_to_root, value)
    if key == 'CC':
      cc = os.path.join(build_to_root, value)
      if cc.endswith('clang-cl'):
        clang_cl = cc
    if key == 'CXX':
      cxx = os.path.join(build_to_root, value)
    if key == 'CC.host':
      cc_host = os.path.join(build_to_root, value)
      cc_host_global_setting = value
    if key == 'CXX.host':
      cxx_host = os.path.join(build_to_root, value)
      cxx_host_global_setting = value
    if key == 'LD':
      ld = os.path.join(build_to_root, value)
    if key == 'LD.host':
      ld_host = os.path.join(build_to_root, value)
    if key == 'NM':
      nm = os.path.join(build_to_root, value)
    if key == 'NM.host':
      nm_host = os.path.join(build_to_root, value)
    if key == 'READELF':
      readelf = os.path.join(build_to_root, value)
    if key == 'READELF.host':
      readelf_host = os.path.join(build_to_root, value)
    if key.endswith('_wrapper'):
      wrappers[key[:-len('_wrapper')]] = os.path.join(build_to_root, value)

  # Support wrappers from environment variables too.
  for key, value in os.environ.iteritems():
    if key.lower().endswith('_wrapper'):
      key_prefix = key[:-len('_wrapper')]
      key_prefix = re.sub(r'\.HOST$', '.host', key_prefix)
      wrappers[key_prefix] = os.path.join(build_to_root, value)

  if flavor == 'win':
    configs = [target_dicts[qualified_target]['configurations'][config_name]
               for qualified_target in target_list]
    shared_system_includes = None
    if not generator_flags.get('ninja_use_custom_environment_files', 0):
      shared_system_includes = \
          gyp.msvs_emulation.ExtractSharedMSVSSystemIncludes(
              configs, generator_flags)
    cl_paths = gyp.msvs_emulation.GenerateEnvironmentFiles(
        toplevel_build, generator_flags, shared_system_includes, OpenOutput)
    for arch, path in cl_paths.iteritems():
      if clang_cl:
        # If we have selected clang-cl, use that instead.
        path = clang_cl
      command = CommandWithWrapper('CC', wrappers,
          QuoteShellArgument(path, 'win'))
      if clang_cl:
        # Use clang-cl to cross-compile for x86 or x86_64.
        command += (' -m32' if arch == 'x86' else ' -m64')
      master_ninja.variable('cl_' + arch, command)

  cc = GetEnvironFallback(['CC_target', 'CC'], cc)
  master_ninja.variable('cc', CommandWithWrapper('CC', wrappers, cc))
  cxx = GetEnvironFallback(['CXX_target', 'CXX'], cxx)
  master_ninja.variable('cxx', CommandWithWrapper('CXX', wrappers, cxx))

  if flavor == 'win':
    master_ninja.variable('ld', ld)
    master_ninja.variable('idl', 'midl.exe')
    master_ninja.variable('ar', ar)
    master_ninja.variable('rc', 'rc.exe')
    master_ninja.variable('ml_x86', 'ml.exe')
    master_ninja.variable('ml_x64', 'ml64.exe')
    master_ninja.variable('mt', 'mt.exe')
  else:
    master_ninja.variable('ld', CommandWithWrapper('LINK', wrappers, ld))
    master_ninja.variable('ldxx', CommandWithWrapper('LINK', wrappers, ldxx))
    master_ninja.variable('ar', GetEnvironFallback(['AR_target', 'AR'], ar))
    if flavor != 'mac':
      # Mac does not use readelf/nm for .TOC generation, so avoiding polluting
      # the master ninja with extra unused variables.
      master_ninja.variable(
          'nm', GetEnvironFallback(['NM_target', 'NM'], nm))
      master_ninja.variable(
          'readelf', GetEnvironFallback(['READELF_target', 'READELF'], readelf))

  if generator_supports_multiple_toolsets:
    if not cc_host:
      cc_host = cc
    if not cxx_host:
      cxx_host = cxx

    master_ninja.variable('ar_host', GetEnvironFallback(['AR_host'], ar_host))
    master_ninja.variable('nm_host', GetEnvironFallback(['NM_host'], nm_host))
    master_ninja.variable('readelf_host',
                          GetEnvironFallback(['READELF_host'], readelf_host))
    cc_host = GetEnvironFallback(['CC_host'], cc_host)
    cxx_host = GetEnvironFallback(['CXX_host'], cxx_host)

    # The environment variable could be used in 'make_global_settings', like
    # ['CC.host', '$(CC)'] or ['CXX.host', '$(CXX)'], transform them here.
    if '$(CC)' in cc_host and cc_host_global_setting:
      cc_host = cc_host_global_setting.replace('$(CC)', cc)
    if '$(CXX)' in cxx_host and cxx_host_global_setting:
      cxx_host = cxx_host_global_setting.replace('$(CXX)', cxx)
    master_ninja.variable('cc_host',
                          CommandWithWrapper('CC.host', wrappers, cc_host))
    master_ninja.variable('cxx_host',
                          CommandWithWrapper('CXX.host', wrappers, cxx_host))
    if flavor == 'win':
      master_ninja.variable('ld_host', ld_host)
    else:
      master_ninja.variable('ld_host', CommandWithWrapper(
          'LINK', wrappers, ld_host))
      master_ninja.variable('ldxx_host', CommandWithWrapper(
          'LINK', wrappers, ldxx_host))

  master_ninja.newline()

  master_ninja.pool('link_pool', depth=GetDefaultConcurrentLinks())
  master_ninja.newline()

  deps = 'msvc' if flavor == 'win' else 'gcc'

  if flavor != 'win':
    master_ninja.rule(
      'cc',
      description='CC $out',
      command=('$cc -MMD -MF $out.d $defines $includes $cflags $cflags_c '
              '$cflags_pch_c -c $in -o $out'),
      depfile='$out.d',
      deps=deps)
    master_ninja.rule(
      'cc_s',
      description='CC $out',
      command=('$cc $defines $includes $cflags $cflags_c '
              '$cflags_pch_c -c $in -o $out'))
    master_ninja.rule(
      'cxx',
      description='CXX $out',
      command=('$cxx -MMD -MF $out.d $defines $includes $cflags $cflags_cc '
              '$cflags_pch_cc -c $in -o $out'),
      depfile='$out.d',
      deps=deps)
  else:
    # TODO(scottmg) Separate pdb names is a test to see if it works around
    # http://crbug.com/142362. It seems there's a race between the creation of
    # the .pdb by the precompiled header step for .cc and the compilation of
    # .c files. This should be handled by mspdbsrv, but rarely errors out with
    #   c1xx : fatal error C1033: cannot open program database
    # By making the rules target separate pdb files this might be avoided.
    cc_command = ('ninja -t msvc -e $arch ' +
                  '-- '
                  '$cc /nologo /showIncludes /FC '
                  '@$out.rsp /c $in /Fo$out /Fd$pdbname_c ')
    cxx_command = ('ninja -t msvc -e $arch ' +
                   '-- '
                   '$cxx /nologo /showIncludes /FC '
                   '@$out.rsp /c $in /Fo$out /Fd$pdbname_cc ')
    master_ninja.rule(
      'cc',
      description='CC $out',
      command=cc_command,
      rspfile='$out.rsp',
      rspfile_content='$defines $includes $cflags $cflags_c',
      deps=deps)
    master_ninja.rule(
      'cxx',
      description='CXX $out',
      command=cxx_command,
      rspfile='$out.rsp',
      rspfile_content='$defines $includes $cflags $cflags_cc',
      deps=deps)
    master_ninja.rule(
      'idl',
      description='IDL $in',
      command=('%s gyp-win-tool midl-wrapper $arch $outdir '
               '$tlb $h $dlldata $iid $proxy $in '
               '$midl_includes $idlflags' % sys.executable))
    master_ninja.rule(
      'rc',
      description='RC $in',
      # Note: $in must be last otherwise rc.exe complains.
      command=('%s gyp-win-tool rc-wrapper '
               '$arch $rc $defines $resource_includes $rcflags /fo$out $in' %
               sys.executable))
    master_ninja.rule(
      'asm',
      description='ASM $out',
      command=('%s gyp-win-tool asm-wrapper '
               '$arch $asm $defines $includes $asmflags /c /Fo $out $in' %
               sys.executable))

  if flavor != 'mac' and flavor != 'win':
    master_ninja.rule(
      'alink',
      description='AR $out',
      command='rm -f $out && $ar rcs $arflags $out $in')
    master_ninja.rule(
      'alink_thin',
      description='AR $out',
      command='rm -f $out && $ar rcsT $arflags $out $in')

    # This allows targets that only need to depend on $lib's API to declare an
    # order-only dependency on $lib.TOC and avoid relinking such downstream
    # dependencies when $lib changes only in non-public ways.
    # The resulting string leaves an uninterpolated %{suffix} which
    # is used in the final substitution below.
    mtime_preserving_solink_base = (
        'if [ ! -e $lib -o ! -e $lib.TOC ]; then '
        '%(solink)s && %(extract_toc)s > $lib.TOC; else '
        '%(solink)s && %(extract_toc)s > $lib.tmp && '
        'if ! cmp -s $lib.tmp $lib.TOC; then mv $lib.tmp $lib.TOC ; '
        'fi; fi'
        % { 'solink':
              '$ld -shared $ldflags -o $lib -Wl,-soname=$soname %(suffix)s',
            'extract_toc':
              ('{ $readelf -d $lib | grep SONAME ; '
               '$nm -gD -f p $lib | cut -f1-2 -d\' \'; }')})

    master_ninja.rule(
      'solink',
      description='SOLINK $lib',
      restat=True,
      command=mtime_preserving_solink_base % {'suffix': '@$link_file_list'},
      rspfile='$link_file_list',
      rspfile_content=
          '-Wl,--whole-archive $in $solibs -Wl,--no-whole-archive $libs',
      pool='link_pool')
    master_ninja.rule(
      'solink_module',
      description='SOLINK(module) $lib',
      restat=True,
      command=mtime_preserving_solink_base % {'suffix': '@$link_file_list'},
      rspfile='$link_file_list',
      rspfile_content='-Wl,--start-group $in -Wl,--end-group $solibs $libs',
      pool='link_pool')
    master_ninja.rule(
      'link',
      description='LINK $out',
      command=('$ld $ldflags -o $out '
               '-Wl,--start-group $in -Wl,--end-group $solibs $libs'),
      pool='link_pool')
  elif flavor == 'win':
    master_ninja.rule(
        'alink',
        description='LIB $out',
        command=('%s gyp-win-tool link-wrapper $arch False '
                 '$ar /nologo /ignore:4221 /OUT:$out @$out.rsp' %
                 sys.executable),
        rspfile='$out.rsp',
        rspfile_content='$in_newline $libflags')
    _AddWinLinkRules(master_ninja, embed_manifest=True)
    _AddWinLinkRules(master_ninja, embed_manifest=False)
  else:
    master_ninja.rule(
      'objc',
      description='OBJC $out',
      command=('$cc -MMD -MF $out.d $defines $includes $cflags $cflags_objc '
               '$cflags_pch_objc -c $in -o $out'),
      depfile='$out.d',
      deps=deps)
    master_ninja.rule(
      'objcxx',
      description='OBJCXX $out',
      command=('$cxx -MMD -MF $out.d $defines $includes $cflags $cflags_objcc '
               '$cflags_pch_objcc -c $in -o $out'),
      depfile='$out.d',
      deps=deps)
    master_ninja.rule(
      'alink',
      description='LIBTOOL-STATIC $out, POSTBUILDS',
      command='rm -f $out && '
              './gyp-mac-tool filter-libtool libtool $libtool_flags '
              '-static -o $out $in'
              '$postbuilds')
    master_ninja.rule(
      'lipo',
      description='LIPO $out, POSTBUILDS',
      command='rm -f $out && lipo -create $in -output $out$postbuilds')
    master_ninja.rule(
      'solipo',
      description='SOLIPO $out, POSTBUILDS',
      command=(
          'rm -f $lib $lib.TOC && lipo -create $in -output $lib$postbuilds &&'
          '%(extract_toc)s > $lib.TOC'
          % { 'extract_toc':
                '{ otool -l $lib | grep LC_ID_DYLIB -A 5; '
                'nm -gP $lib | cut -f1-2 -d\' \' | grep -v U$$; true; }'}))


    # Record the public interface of $lib in $lib.TOC. See the corresponding
    # comment in the posix section above for details.
    solink_base = '$ld %(type)s $ldflags -o $lib %(suffix)s'
    mtime_preserving_solink_base = (
        'if [ ! -e $lib -o ! -e $lib.TOC ] || '
             # Always force dependent targets to relink if this library
             # reexports something. Handling this correctly would require
             # recursive TOC dumping but this is rare in practice, so punt.
             'otool -l $lib | grep -q LC_REEXPORT_DYLIB ; then '
          '%(solink)s && %(extract_toc)s > $lib.TOC; '
        'else '
          '%(solink)s && %(extract_toc)s > $lib.tmp && '
          'if ! cmp -s $lib.tmp $lib.TOC; then '
            'mv $lib.tmp $lib.TOC ; '
          'fi; '
        'fi'
        % { 'solink': solink_base,
            'extract_toc':
              '{ otool -l $lib | grep LC_ID_DYLIB -A 5; '
              'nm -gP $lib | cut -f1-2 -d\' \' | grep -v U$$; true; }'})


    solink_suffix = '@$link_file_list$postbuilds'
    master_ninja.rule(
      'solink',
      description='SOLINK $lib, POSTBUILDS',
      restat=True,
      command=mtime_preserving_solink_base % {'suffix': solink_suffix,
                                              'type': '-shared'},
      rspfile='$link_file_list',
      rspfile_content='$in $solibs $libs',
      pool='link_pool')
    master_ninja.rule(
      'solink_notoc',
      description='SOLINK $lib, POSTBUILDS',
      restat=True,
      command=solink_base % {'suffix':solink_suffix, 'type': '-shared'},
      rspfile='$link_file_list',
      rspfile_content='$in $solibs $libs',
      pool='link_pool')

    master_ninja.rule(
      'solink_module',
      description='SOLINK(module) $lib, POSTBUILDS',
      restat=True,
      command=mtime_preserving_solink_base % {'suffix': solink_suffix,
                                              'type': '-bundle'},
      rspfile='$link_file_list',
      rspfile_content='$in $solibs $libs',
      pool='link_pool')
    master_ninja.rule(
      'solink_module_notoc',
      description='SOLINK(module) $lib, POSTBUILDS',
      restat=True,
      command=solink_base % {'suffix': solink_suffix, 'type': '-bundle'},
      rspfile='$link_file_list',
      rspfile_content='$in $solibs $libs',
      pool='link_pool')

    master_ninja.rule(
      'link',
      description='LINK $out, POSTBUILDS',
      command=('$ld $ldflags -o $out '
               '$in $solibs $libs$postbuilds'),
      pool='link_pool')
    master_ninja.rule(
      'preprocess_infoplist',
      description='PREPROCESS INFOPLIST $out',
      command=('$cc -E -P -Wno-trigraphs -x c $defines $in -o $out && '
               'plutil -convert xml1 $out $out'))
    master_ninja.rule(
      'copy_infoplist',
      description='COPY INFOPLIST $in',
      command='$env ./gyp-mac-tool copy-info-plist $in $out $binary $keys')
    master_ninja.rule(
      'merge_infoplist',
      description='MERGE INFOPLISTS $in',
      command='$env ./gyp-mac-tool merge-info-plist $out $in')
    master_ninja.rule(
      'compile_xcassets',
      description='COMPILE XCASSETS $in',
      command='$env ./gyp-mac-tool compile-xcassets $keys $in')
    master_ninja.rule(
      'mac_tool',
      description='MACTOOL $mactool_cmd $in',
      command='$env ./gyp-mac-tool $mactool_cmd $in $out $binary')
    master_ninja.rule(
      'package_framework',
      description='PACKAGE FRAMEWORK $out, POSTBUILDS',
      command='./gyp-mac-tool package-framework $out $version$postbuilds '
              '&& touch $out')
  if flavor == 'win':
    master_ninja.rule(
      'stamp',
      description='STAMP $out',
      command='%s gyp-win-tool stamp $out' % sys.executable)
    master_ninja.rule(
      'copy',
      description='COPY $in $out',
      command='%s gyp-win-tool recursive-mirror $in $out' % sys.executable)
  else:
    master_ninja.rule(
      'stamp',
      description='STAMP $out',
      command='${postbuilds}touch $out')
    master_ninja.rule(
      'copy',
      description='COPY $in $out',
      command='rm -rf $out && cp -af $in $out')
  master_ninja.newline()

  all_targets = set()
  for build_file in params['build_files']:
    for target in gyp.common.AllTargets(target_list,
                                        target_dicts,
                                        os.path.normpath(build_file)):
      all_targets.add(target)
  all_outputs = set()

  # target_outputs is a map from qualified target name to a Target object.
  target_outputs = {}
  # target_short_names is a map from target short name to a list of Target
  # objects.
  target_short_names = {}

  # short name of targets that were skipped because they didn't contain anything
  # interesting.
  # NOTE: there may be overlap between this an non_empty_target_names.
  empty_target_names = set()

  # Set of non-empty short target names.
  # NOTE: there may be overlap between this an empty_target_names.
  non_empty_target_names = set()

  for qualified_target in target_list:
    # qualified_target is like: third_party/icu/icu.gyp:icui18n#target
    build_file, name, toolset = \
        gyp.common.ParseQualifiedTarget(qualified_target)

    this_make_global_settings = data[build_file].get('make_global_settings', [])
    assert make_global_settings == this_make_global_settings, (
        "make_global_settings needs to be the same for all targets. %s vs. %s" %
        (this_make_global_settings, make_global_settings))

    spec = target_dicts[qualified_target]
    if flavor == 'mac':
      gyp.xcode_emulation.MergeGlobalXcodeSettingsToSpec(data[build_file], spec)

    # If build_file is a symlink, we must not follow it because there's a chance
    # it could point to a path above toplevel_dir, and we cannot correctly deal
    # with that case at the moment.
    build_file = gyp.common.RelativePath(build_file, options.toplevel_dir,
                                         False)

    qualified_target_for_hash = gyp.common.QualifiedTarget(build_file, name,
                                                           toolset)
    hash_for_rules = hashlib.md5(qualified_target_for_hash).hexdigest()

    base_path = os.path.dirname(build_file)
    obj = 'obj'
    if toolset != 'target':
      obj += '.' + toolset
    output_file = os.path.join(obj, base_path, name + '.ninja')

    ninja_output = StringIO()
    writer = NinjaWriter(hash_for_rules, target_outputs, base_path, build_dir,
                         ninja_output,
                         toplevel_build, output_file,
                         flavor, toplevel_dir=options.toplevel_dir)

    target = writer.WriteSpec(spec, config_name, generator_flags)

    if ninja_output.tell() > 0:
      # Only create files for ninja files that actually have contents.
      with OpenOutput(os.path.join(toplevel_build, output_file)) as ninja_file:
        ninja_file.write(ninja_output.getvalue())
      ninja_output.close()
      master_ninja.subninja(output_file)

    if target:
      if name != target.FinalOutput() and spec['toolset'] == 'target':
        target_short_names.setdefault(name, []).append(target)
      target_outputs[qualified_target] = target
      if qualified_target in all_targets:
        all_outputs.add(target.FinalOutput())
      non_empty_target_names.add(name)
    else:
      empty_target_names.add(name)

  if target_short_names:
    # Write a short name to build this target.  This benefits both the
    # "build chrome" case as well as the gyp tests, which expect to be
    # able to run actions and build libraries by their short name.
    master_ninja.newline()
    master_ninja.comment('Short names for targets.')
    for short_name in target_short_names:
      master_ninja.build(short_name, 'phony', [x.FinalOutput() for x in
                                               target_short_names[short_name]])

  # Write phony targets for any empty targets that weren't written yet. As
  # short names are  not necessarily unique only do this for short names that
  # haven't already been output for another target.
  empty_target_names = empty_target_names - non_empty_target_names
  if empty_target_names:
    master_ninja.newline()
    master_ninja.comment('Empty targets (output for completeness).')
    for name in sorted(empty_target_names):
      master_ninja.build(name, 'phony')

  if all_outputs:
    master_ninja.newline()
    master_ninja.build('all', 'phony', list(all_outputs))
    master_ninja.default(generator_flags.get('default_target', 'all'))

  master_ninja_file.close()


def PerformBuild(data, configurations, params):
  options = params['options']
  for config in configurations:
    builddir = os.path.join(options.toplevel_dir, 'out', config)
    arguments = ['ninja', '-C', builddir]
    print 'Building [%s]: %s' % (config, arguments)
    subprocess.check_call(arguments)


def CallGenerateOutputForConfig(arglist):
  # Ignore the interrupt signal so that the parent process catches it and
  # kills all multiprocessing children.
  signal.signal(signal.SIGINT, signal.SIG_IGN)

  (target_list, target_dicts, data, params, config_name) = arglist
  GenerateOutputForConfig(target_list, target_dicts, data, params, config_name)


def GenerateOutput(target_list, target_dicts, data, params):
  # Update target_dicts for iOS device builds.
  target_dicts = gyp.xcode_emulation.CloneConfigurationForDeviceAndEmulator(
      target_dicts)

  user_config = params.get('generator_flags', {}).get('config', None)
  if gyp.common.GetFlavor(params) == 'win':
    target_list, target_dicts = MSVSUtil.ShardTargets(target_list, target_dicts)
    target_list, target_dicts = MSVSUtil.InsertLargePdbShims(
        target_list, target_dicts, generator_default_variables)

  if user_config:
    GenerateOutputForConfig(target_list, target_dicts, data, params,
                            user_config)
  else:
    config_names = target_dicts[target_list[0]]['configurations'].keys()
    if params['parallel']:
      try:
        pool = multiprocessing.Pool(len(config_names))
        arglists = []
        for config_name in config_names:
          arglists.append(
              (target_list, target_dicts, data, params, config_name))
        pool.map(CallGenerateOutputForConfig, arglists)
      except KeyboardInterrupt, e:
        pool.terminate()
        raise e
    else:
      for config_name in config_names:
        GenerateOutputForConfig(target_list, target_dicts, data, params,
                                config_name)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-MC35ML');</script>
    <script src="https://store.unity.com/themes/contrib/unity_base/js/unity-cdp.js">
    </script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unity - : </title>
    <meta property="og:image" content="https://unity3d.com/files/images/ogimg.jpg" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="../StaticFiles/images/favicons/favicon.ico" />
    <link rel="icon" type="image/png" href="../StaticFiles/images/favicons/favicon.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png" />
    <meta name="msapplication-TileColor" content="#222c37" />
    <meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png" />
    <script type="text/javascript" src="../StaticFiles/js/jquery.js">
    </script>
    <script type="text/javascript" src="docdata/toc.js">//toc</script>
    <!--local TOC-->
    <script type="text/javascript" src="docdata/global_toc.js">//toc</script>
    <!--global TOC, including other platforms-->
    <script type="text/javascript" src="../StaticFiles/js/core.js">
    </script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css" />
    <link rel="stylesheet" href="../StaticFiles/js/feedback/five-star-rating-master/css/rating.min.css" />
    <script src="../StaticFiles/js/feedback/five-star-rating-master/js/src/rating.js">
    </script>
  </head>
  <body>
    <noscript>
      <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MC35ML" height="0" width="0" style="display:none;visibility:hidden">
      </iframe>
    </noscript>
    <div class="header-wrapper">
      <div id="header" class="header">
        <div class="content">
          <div class="spacer">
            <div class="menu">
              <div class="logo">
                <a href="">
                </a>
              </div>
              <div class="search-form">
                <form action="30_search.html" method="get" class="apisearch">
                  <input type="text" name="q" placeholder="Search scripting..." autosave="Unity Reference" results="5" class="sbox field" id="q">
                  </input>
                  <input type="submit" class="submit">
                  </input>
                </form>
              </div>
              <ul>
                <li>
                  <a href="../Manual/index.html">
                  </a>
                </li>
                <li>
                  <a href="../ScriptReference/index.html" class="selected">
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div class="more">
            <div class="filler">
            </div>
            <ul>
              <li>
                <a href="https://unity3d.com/">unity3d.com</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="toolbar">
        <div class="content clear">
          <div class="version-number">Version: <b>2018.2b</b> (switch to <a href="https://docs.unity3d.com/2018.1/Documentation/ScriptReference">2018.1</a> or <a href="https://docs.unity3d.com/2017.4/Documentation/ScriptReference">2017.4</a>)</div>
          <div class="lang-switcher hide">
            <div class="current toggle" data-target=".lang-list">
              <div class="lbl">
                <span class="b">English</span>
              </div>
              <div class="arrow">
              </div>
            </div>
            <div class="lang-list" style="display:none;">
              <ul>
                <li>
                  <a href="">English</a>
                </li>
              </ul>
            </div>
          </div>
          <div class="script-lang">
            <ul>
              <li class="selected" data-lang="CS">C#</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div id="master-wrapper" class="master-wrapper clear">
      <div id="sidebar" class="sidebar">
        <div class="sidebar-wrap">
          <div class="content">
            <div class="sidebar-menu">
              <div class="toc">
                <h2>
                </h2>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="content-wrap" class="content-wrap">
        <div class="content-block">
          <div class="content">
            <div class="section">
            </div>
            <div class="section">
              <div class="feedbackbox" id="feedbackbox">
                <div id="rating">
                  <p>
                    <br />
                    <div id="ratecontent" class="c-rating">
                    </div>
                  </p>
                </div>
                <div id="ratingThanks" style="display:none">
                  <p>
                  </p>
                </div>
                <div id="problem">
                  <p>
                    <a name="problem" onclick="document.getElementById('problemType').style.display = '';document.getElementById('problem').style.display = 'none';">
                    </a>
                  </p>
                </div>
                <div id="problemType" style="display:none">
                  <p>
                    <ul type="problems">
                      <li>
                        <a name="needcode" onclick="                                                             document.getElementById('problemType').style.display = 'none';                                                             document.getElementById('problemThanks').style.display = '';                                                             SendFeedback('problem-needcode',window.location.href,0);                                                             document.getElementById('problemFormDescription').value='Needs code samples.';                                                             document.getElementById('problemNeedCodeForm').style.display = ''                                                         ">
                        </a>
                      </li>
                      <li>
                        <a name="code" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-brokencode',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='Code samples do not work.';                                                         document.getElementById('problemCodeForm').style.display = ''                                                         ">
                        </a>
                      </li>
                      <li>
                        <a name="missing" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-missing',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='Missing information';                                                         document.getElementById('problemMissingForm').style.display = ''                                                         ">
                        </a>
                      </li>
                      <li>
                        <a name="incorrect" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-incorrect',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='Incorrect information';                                                         document.getElementById('problemIncorrectForm').style.display = ''                                                         ">
                        </a>
                      </li>
                      <li>
                        <a name="unclear" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-unclear',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='Unclear or confusing information';                                                         document.getElementById('problemUnclearForm').style.display = ''                                                         ">
                        </a>
                      </li>
                      <li>
                        <a name="language" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-language',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='Spelling or grammar error';                                                         document.getElementById('problemLanguageForm').style.display = ''                                                         ">
                        </a>
                      </li>
                      <li>
                        <a name="other" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-other',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='This page has a problem';                                                         document.getElementById('problemOtherForm').style.display = ''                                                         ">
                        </a>
                      </li>
                    </ul>
                    <p>
                    </p>
                  </p>
                </div>
                <div id="problemThanks" style="display:none">
                  <p>
                    <br />
                    <br />
                    <br />
                    <br />
                    <a onclick="document.getElementById('problemMoreInfo').style.display = '';document.getElementById('problemThanks').style.display = 'none';">
                    </a>
                    <br />
                  </p>
                </div>
                <div id="problemMoreInfo" style="display:none">
                  <p id="problemNeedCodeForm" style="display:none">
                  </p>
                  <p id="problemCodeForm" style="display:none">
                  </p>
                  <p id="problemMissingForm" style="display:none">
                  </p>
                  <p id="problemIncorrectForm" style="display:none">
                  </p>
                  <p id="problemUnclearForm" style="display:none">
                  </p>
                  <p id="problemLanguageForm" style="display:none">
                  </p>
                  <p id="problemOtherForm" style="display:none">
                  </p>
                  <form>
                    <textarea id="problemFormSuggestionField" cols="40" rows="5">
                    </textarea>
                    <input type="hidden" id="problemFormDescription">
                    </input>
                    <input type="submit" id="problemFormDescriptionSubmit" value="Submit" onclick="                                             document.getElementById('problemMoreInfo').style.display = 'none';                                             document.getElementById('problemMoreInfoThanks').style.display = '';                                             return false;                                             ">
                    </input>
                  </form>
                </div>
                <div id="problemMoreInfoThanks" style="display:none">
                  <p>
                  </p>
                </div>
                <script>

                                            var ratecontent = document.querySelector('#ratecontent'); // target element
                                            var currentRating = 0; // initial rating
                                            var maxRating= 5; // max rating

                                            // callback to run after setting the rating
                                            var callback = function(rating) {
                                                document.getElementById('ratingThanks').style.display = '';
                                                document.getElementById('ratecontent').style.display = 'none';
                                                document.getElementById('rating').style.display = 'none';
                                                SendFeedback("rating",window.location.href,rating);
                                            };

                                            // rating instance
                                            var myRating = rating(ratecontent, currentRating, maxRating, callback);
                                        </script>
              </div>
            </div>
            <div class="footer-wrapper">
              <div class="footer clear">
                <div class="copy">
                  <p>
                    <a href="">
                    </a>.</p>. Publication: 2018.2b-002B. Built: 2018-04-30.</div>
                <div class="menu">
                  <a href="">
                  </a>
                  <a href="">
                  </a>
                  <a href="">
                  </a>
                  <a href="">
                  </a>
                  <a href="">
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>                                                                                                                                                                          REDI     DATA     P                   4                             X                         R          b      f   panorama/layout/custom_game/tutorial_client_code.vxml dota_addons/tutorial_basics panorama/layout/custom_game/tutorial_client_code.xml dota_addons/tutorial_basics     $           ___OverrideInputData___ BinaryBlobArg                 CompilePanorama Panorama Layout Compiler Version           IsChildResource R  <root>
  <styles>
    <include src="s2r://panorama/styles/dotastyles.vcss_c" />
  </styles>
  <scripts>
    <include src="s2r://panorama/scripts/custom_game/client_code.vjs_c" />
  </scripts>
  <Panel>
  </Panel>
</root>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             IDST1   <player/custom_player/kuristaja/hitler/hitler_arms.mdl           A              :MW RAB^<BE+@AihB                           $                     $     '             )     )        )     x(             x(  x(      )      )      )      )      )      )  =  )  r       )    ?       )      =      )      $                      )                    L*          (  <                                                                                                                                                                                                                                          S;  cuAGY?T`JB;F?
T<	HY ; ; ;mI7]7"R8g~?,U	<z(~={?ET<SK8?I                               K;                                     :      $A  4  <5>$,?) ; ; ;mI7mI7mI7h}?LX=J=C}3y>B.=~?>                               s:                                     9     #??>?>0265??q?1> ; ; ;mI7mI7mI7WA?}'?'K?z>//=#wo?E]b                               9                                     9     ?  5  6c~2jk:i=?k*s;[= ; ; ;mI7mI7mI71J?Z>1~T?t_@>=i?>b                               8                                     U8     H/?      )2.0|<?  @3   h= ; ; ;mI7mI7mI7P?)6SJ.e>;\?C`P@>
=i?>b                               7                                     7     `q@ m>wx>|=]I|?<>e> ; ; ;mI7mI7mI7T@n?-{D-`25~pWB>,o?                               7                                     6     {?       -4<+?    e4= ; ; ;mI7mI7mI7l?@|[B>,o?                               ;6                                     6     s?   7   522<?     4= ; ; ;mI7mI7mI7nk?f*.&oT8H{x^B>,o?                               c5                                     \5     P+s@ t< #h8;^$= ~?-rI> ; ; ;mI7mI7mI70~?AusJG~(UB=w~?yUD>?                               4                                     4     0/?  6  Gl>2=ls?2^*> ; ; ;mI7mI7mI7x?'n][`au@y0aB=w~?zUH>?                               3                                     3  	    "?      ]0V*@2l5<?02m< ; ; ;mI7mI7mI7w?cqwU`wrlwcB=w~?{UH>?                               2                                     !3     Ph@ q=A?rt	>-{?,15{> ; ; ;mI7mI7mI7!y?K> 5&$d0{j[B&{?$@                               2                                     b2     ?       1wP+=? @  2C]= ; ; ;mI7mI7mI7t?gU>;>yTvbB&{?&@                               +1                                     1     `g?  @7    12u<?   2< ; ; ;mI7mI7mI7r?	>ka|>xntdB&{?(@                               S0                                     0     T@ \o>VR??<e>BTt?0)Y> ; ; ;mI7mI7mI71d??>`byjtPIyC^BWRj? m;7A                               {/                                     '0     v?   7  ZHFd=X?    z+= ; ; ;mI7mI7mI7S\?@k> p$RqOAdBWRj?m;7A                               .                                     i/     p.?     5yO2{O<?    2< ; ; ;mI7mI7mI7Z?U>,Rlq'oJeBWRj?m;7A                               -                                     .  cuAGY?T`JB<L?<	W ; ; ;mI7]7R8}?#	<jz*=s?<ia?(I                               ,                                     -  euW?T`JB!<F;;H@	iE ; ; ;mI7]7!@8d~/9	<zE~{?8T<S:K<8IB                               ,                                     /-     $A    @2;?><yJ:-?fJ?= ; ; ;mI7mI7mI7'}.c=0(^+w}b=B=G~u=Y>                               C+                                     m,     `#? A>?5Q)Z2&?J> ; ; ;mI7mI7mI725&f}'7@?j?h>=Ru8^B                               k*                                     +     ?  5  J1=(=7~?e=21> ; ; ;mI7mI7mI7NnU5I;B[?r	]I>=r&aB                               )                                     *     /?      @7/2?    2 ; ; ;mI7mI7mI7{IO_FV?t3I>=r#aB                               (                                     2*     0q@ l>wx?D;
=64|?,;.]> ; ; ;mI7mI7mI7m:=@~VB>Yn=C@                               '                                     s)     {?      V4 ==?  Q= ; ; ;mI7mI7mI7nkY@<$>	%|\B>Yn=C@                               '                                     (     s?     6-KxUQ=?   = ; ; ;mI7mI7mI7NeK{ Dh><w5dB>Yn=C@                               3&                                     '     P+s@ @u< #=
<K=	~?OA3|> ; ; ;mI7mI7mI7|bBL	{>~:>}YBp=}}=p{?                               [%                                     8'     @/?      0%.<?1   %= ; ; ;mI7mI7mI7^zz'T->u[)|
]Bp=}}=p{?                               $                                     z&     !?       L0i|bz;=Q?0  (= ; ; ;mI7mI7mI7NuuCPHG>LlG1w=eBq=}}=p{?                               #                                     %     0h@ q=A{<=zQ>%{?HP=Vph>6> ; ; ;mI7mI7mI7Mz:=.T	#>!o{x[B|=~                               "                                     $     p?        i/1_2~<m?  1  3l= ; ; ;mI7mI7mI7x[x=nO(UC>DyYZ^B|=                               !                                     ?$     g?      51f=?     2A= ; ; ;mI7mI7mI7q=Re%>(ur&HfB|=                               #!                                     #     `T@ ^o>RRx1;g>+>u?@O=/>B> ; ; ;mI7mI7mI76h>}/jA]>Qvw^B%oF?="p)                               K                                      "      v?  @7   T1 3=<?  2 3Y= ; ; ;mI7mI7mI7:eT>T
J(>*(tHaB%oF?="p)                               s                                     "  !   .?     5'1822}?   2  32 ; ; ;mI7mI7mI7%:f>8[>t>SaB%oF?=$p)                                                                    F!  euW?T`JB<K;G@	E ; ; ;mI7]7@8}9	<MzM-s?*<<i3a<*IB                                                                                    N3$A$@^@                                         pe
l1*&5K@hF? @d                                         t[j
@R??                                          8g,*V{]a@u?K?                                         VOu??!5?                                         ~J	K	3o8>?t>z?T                                         ^4J9A7$@^@                                         N^$A$@?                                         	2pp @=*?X'@                                         hP@?!?D                                         !P@F?>?Tb>                                          !u'"kS@J ?x?                                         _Tp57?!?xN?x                                  #       /4^J9A$@?4                                  	
  !"#     A                                           p                                                        ! so&jKSR  pU>  ^Wd?      :?      :?  0r$2+@      @      @  @	      @
      @  /7SA      @      @  Aq@      @! K*jKSR! X2SR  E[V>  f?      :?      :?  1+@      @      @  @      @      @  H)SA      @      @   7Rr@!      @"      @#!  >8SR    w                   ^<BE+@AihB   d                                L>L>                                                      d  h          h      h                    ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?  ?               hitler_arms_ref.smd                                                                                   P                                    l                                      *y                                                                                                              A      mdlkeyvalue
{
qc_path {
"value" "i:\i-stuff\software\tutorial\3dsmax\export\csgo\hitler\arms\hitler_arms.qc" }
}
   $   @      `    P       p                                                                                                                                                                     	                                                                   !   cuAGY?T`JB$A  4  #??>?  5  6H/?      `q@ m>wx{?       s?   7   5P+s@ t< #0/?  6   "?      Ph@ q=A??       `g?  @7    T@ \o>VR?v?   7  p.?     5cuAGY?T`JBeuW?T`JB$A    @`#? A>??  5  /?      @70q@ l>wx?{?      s?     6P+s@ @u< #=@/?      !?       0h@ q=Ap?        g?      5`T@ ^o>RRv?  @7   .?     5euW?T`JB;F?<5>$,??>0265?c~2jk:i=?)2.0|<?>|=]I|?-4<+?22<?h8;^$= ~?Gl>2=ls?]0V*@2l5<?rt	>-{?1wP+=?12u<??<e>BTt?ZHFd=X?yO2{O<?<L?!<F;2;?><yJ:-?5Q)Z2&?J1=(=7~?/2?D;
=64|?V4 ==?-KxUQ=?
<K=	~?0%.<?L0i|bz;=Q?{<=zQ>%{?i/1_2~<m?1f=?x1;g>+>u?T1 3=<?'1822}?<K;
T<	HY)?q?1>k*s;[=  @3   h=<>e>    e4=     4=-rI>2^*>02m<,15{> @  2C]=   2<0)Y>    z+=    2<<	W;H@	iEfJ?=J>e=21>    2,;.]>  Q=   =OA3|>1   %=0  (=HP=Vph>6>  1  3l=     2A=@O=/>B>  2 3Y=   2  32G@	Eg~?,U	<z(~={?ET<SK8?Ih}?LX=J=C}3y>B.=~?>WA?}'?'K?z>//=#wo?E]b1J?Z>1~T?t_@>=i?>bP?)6SJ.e>;\?C`P@>
=i?>bT@n?-{D-`25~pWB>,o?l?@|[B>,o?nk?f*.&oT8H{x^B>,o?0~?AusJG~(UB=w~?yUD>?x?'n][`au@y0aB=w~?zUH>?w?cqwU`wrlwcB=w~?{UH>?!y?K> 5&$d0{j[B&{?$@t?gU>;>yTvbB&{?&@r?	>ka|>xntdB&{?(@1d??>`byjtPIyC^BWRj? m;7AS\?@k> p$RqOAdBWRj?m;7AZ?U>,Rlq'oJeBWRj?m;7A}?#	<jz*=s?<ia?(Id~/9	<zE~{?8T<S:K<8IB'}.c=0(^+w}b=B=G~u=Y>25&f}'7@?j?h>=Ru8^BNnU5I;B[?r	]I>=r&aB{IO_FV?t3I>=r#aBm:=@~VB>Yn=C@nkY@<$>	%|\B>Yn=C@NeK{ Dh><w5dB>Yn=C@|bBL	{>~:>}YBp=}}=p{?^zz'T->u[)|
]Bp=}}=p{?NuuCPHG>LlG1w=eBq=}}=p{?Mz:=.T	#>!o{x[B|=~x[x=nO(UC>DyYZ^B|=q=Re%>(ur&HfB|=6h>}/jA]>Qvw^B%oF?="p):eT>T
J(>*(tHaB%oF?="p)%:f>8[>t>SaB%oF?=$p)}9	<MzM-s?*<<i3a<*IB ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;mI7]7"R8mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7]7R8mI7]7!@8mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7mI7]7@8                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 player/custom_player/kuristaja/hitler/hitler_arms.mdl default v_weapon.Bip01_L_Forearm v_weapon.Bip01_L_Hand v_weapon.Bip01_L_Finger0 v_weapon.Bip01_L_Finger01 v_weapon.Bip01_L_Finger02 v_weapon.Bip01_L_Finger1 v_weapon.Bip01_L_Finger11 v_weapon.Bip01_L_Finger12 v_weapon.Bip01_L_Finger2 v_weapon.Bip01_L_Finger21 v_weapon.Bip01_L_Finger22 v_weapon.Bip01_L_Finger3 v_weapon.Bip01_L_Finger31 v_weapon.Bip01_L_Finger32 v_weapon.Bip01_L_Finger4 v_weapon.Bip01_L_Finger41 v_weapon.Bip01_L_Finger42 v_weapon.Bip01_L_ForeTwist v_weapon.Bip01_R_Forearm v_weapon.Bip01_R_Hand v_weapon.Bip01_R_Finger0 v_weapon.Bip01_R_Finger01 v_weapon.Bip01_R_Finger02 v_weapon.Bip01_R_Finger1 v_weapon.Bip01_R_Finger11 v_weapon.Bip01_R_Finger12 v_weapon.Bip01_R_Finger2 v_weapon.Bip01_R_Finger21 v_weapon.Bip01_R_Finger22 v_weapon.Bip01_R_Finger3 v_weapon.Bip01_R_Finger31 v_weapon.Bip01_R_Finger32 v_weapon.Bip01_R_Finger4 v_weapon.Bip01_R_Finger41 v_weapon.Bip01_R_Finger42 v_weapon.Bip01_R_ForeTwist @idle idle arms hitlerbody_colspec models\player\kuristaja\hitler\                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             INDX( 	 )`            (   	         .        7              x d     &    7 *ZZZ                       1 0 . 6 5 . 1 5 3 . 2 ~ 5 0 1 4 0          x d     &    7 ****                       1 0 . 6 5 . 1 5 3 . 2 ~ 5 0 2 5 4     $     x d     &    7 $'='='=                       1 0 . 6 5 . 1 5 3 . 2 ~ 5 0 2 7 6     ^     x d     &    7 NJ|!h-!h-!h-                       1 0  6 5 . 1 5 3 . 2 ~ 5 0 3 3 3         	 x d     &    7 M.
t4
t4
t4
                       1 0 . 6 5 . 1 5 3 . 2 ~ 5 1 1 3 9          x d     &    7 $xLLL                       1 0 . 6 5 . 1 5 3 . 2 ~ 5 1 5 7 5          x d     &    7 %ghhh                       1 0 . 6 5 . 1 5 3 . 2 ~ 5 2 2 4 8          x d     &    7  + + + +                       1 0 . 6 5 . 1 5 3 . 2 ~ 5 2 3 3 8         x d     &    7 p`p`p`p`                       1 0 . 6 5 . 1 5 3 . 2 ~ 6 3 0 3 1          x d     &    7  w,t,t,t                       1 0 . 6 5 . 1 5 3 . 2 ~ 6 3 1 3 5          x d     &    7 B6=J6=J6=J                       1 0 . 6 5 . 1 5 3 . 3 ~ 4 9 9 2 5     Q     x d     &    7 ADwADwADwADw                       1 0 . 6 5 . 1 5 3 . 3 ~ 5 0 3 9 5     9     x d     &    7 O6p
 O6p
O6p
O6p
                       1 0 . 6 5 . 1 5 3 . 3 ~ 5 0 8 5 2          x d     &    7 BEiEiEiE                       1 0 . 6 5 . 1 5 3 . 3 ~ 6 0 0 9 4         x d     &    7 b.Jb.Jb.Jb.J                       1 0 . 6 5 . 1 5 3 . 3 ~ 6 0 1 2 6         x d     &    7 6666                       1 0 . 6 5 . 1 5 3 . 3 ~ 6 1 6 1 3         x d     &    7 hXu			                      1 0 . 6 5 . 1 5 3 . 3 ~ 6 1 6 8 9         x d     &    7 }I}I}I                       1 0 . 6 5 . 1 5 3 . 3 ~ 6 2 1 3 7          x d     &    7 K3K3K3K                       1 0 . 6 5 . 1 5 3 . 3 ~ 6 2 2 4 4         x d     &    7 			                       1 0 . 6 5 . 1 5 3 . 3 ~ 6 2 4 1 6                  p`p`                       1 0 6 5 1 5 ~ 1 . 2 ~ 6       9     p Z     &    7 O6p
O6p
O6p
O6p
                       1 0 6 5 1 5 ~ 1 . 3 ~ 5            p Z     &    7 BEiEiEiE                       1 0 6 5 1 5 ~ 1 . 3 ~ 6            p Z     &    7 %ghhh                       1 0 6 5 1 5 ~ 2 . 2 ~ 5            p Z     &    7 b.Jb.Jb.Jb.J                       1 0 6 5 1 5 ~ 2 . 3 ~ 6            p Z     &    7  + + + +                      1 0 6 5 1 5 ~ 3 . 2 ~ 5            p Z     &    7 6666                       1 0 6 5 1 5 ~ 3 . 3 ~ 6            p Z     &    7 *ZZZ                       1 0 6 5 1 5 ~ 4 . 2 ~ 5            p Z     &    7 hXu			                       1 0 6 5 1 5 ~ 4 . 3 ~ 6            p Z     &    7                        1 0 7 A D 1 ~ 1 . 3 ~ 6       $     p Z     &     $'='='=                       1 0 9 7 D 2 ~ 1 . 2 ~ 5             p Z     &    7 K3K3K3K                       1 0 A 8 2 E ~ 1 . 3 ~ 6            p Z     &    7 }I}I}I                       1 0 F 2 5 0 ~ 1 . 3 ~ 6            p Z     &    7 			                       1 0 F E B 2 ~ 1 . 3 ~ 6                                                                                            INDX( 	 +)`           (   P
         ~    7                  x d     &    7 |/?*1?*1?*1                       1 0 . 6 5 . 1 5 3 . 3 ~ 6 5 2 2 5    ^     p Z     &    7 NJ|!h-!h-!h-                       1 0 1 9 3 4 ~ 1 . 2 ~ 5            p Z     &    7 ****                       1 0 4 8 7 9 ~ 1 . 2 ~ 5            p Z     &    7 |/?*1?*1?*1                       1 0 5 B A 5 ~ 1 . 3  6           	 p Z     &    7 M.
t4
t4
t4
                       1 0 6 5 1 5 ~ 1 . 2 ~ 5            p Z     &    7 p`p`p`p`                       1 0 6 5 1 5 ~ 1 . 2 ~ 6            p Z     &    7 B6=J6=J6=J                       1 0 6 5 1 5 ~ 1 . 3 ~ 4       9     p Z     &    7 O6p
O6p
O6p
O6p
                       1 0 6 5 1 5 ~ 1 . 3 ~ 5            p Z     &    7 BEiEiEiE                        1 0 6 5 1 5 ~ 1 . 3 ~ 6            p Z     &    7 %ghhh                       1 0 6 5 1 5 ~ 2 . 2 ~ 5            p Z     &    7  w,t,t,t                       1 0 6 5 1 5 ~ 2 . 2 ~ 6       Q     p Z     &    7 ADwADwADwADw                       1 0 6 5 1 5 ~ 2 . 3 ~ 5            p Z     &    7 b.Jb.Jb.Jb.J                       1 0 6 5 1 5 ~ 2 . 3 ~ 6            p Z     &    7  + + + +                       1 0 6 5 1 5 ~ 3 . 2 ~ 5            p Z     &    7 6666                       1 0 6 5 1 5 ~ 3 . 3 ~ 6            p Z     &    7 *ZZZ                       1 0 6 5 1 5 ~ 4 . 2 ~ 5            p Z     &    7 hXu			                       1 0 6 5 1 5 ~ 4 . 3 ~ 6            p Z     &    7                       1 0 7 A D 1 ~ 1 . 3 ~ 6       $     p Z     &    7 $'='='=                       1 0 9 7 D 2 ~ 1 . 2 ~ 5             p Z     &    7 K3K3K3K                       1 0 A 8 2 E ~ 1 . 3 ~ 6            p Z     &    7 }I}I}I                       1 0 F 2 5 0 ~ 1 . 3 ~ 6            p Z     &    7 $xLLL                       1 0 F 8 5 B ~ 1 . 2 ~ 5            p Z     &     			                       1 0 F E B 2 ~ 1 . 3 ~ 6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           JFIF       C  C   "            	
    } !1AQa"q2#BR$3br	
%&'()*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz        	
   w !1AQaq"2B	#3Rbr
$4%&'()*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz   ? 8-|rrNGBqV6Iic<qj4,yr9kT]3<k22>8_i$$vmE Z8w
I1HC"VXB(L^BK,U7(e\(-F*  \9=+tf~MoSKGO$QgKx"uj'VJTVJ:qrRmBSrJtI*
p)>XSQMYMWP4R+Q&ecp{\c;gB8aMo*C!cah;@XP~0qu' h-RG#9b,##9 FK$k{P.fDFqor<Sks$\Ua2KS82'WTS:J*G;4d $3O(s:*UhsIKo?cp4 xg| 
xcT]B{8,"i7v7-%yWu ?1e^UtoU__xE-Ch_]Yi$f\GJ#=[h>%o6<<IOi+W_/4-:R{GM&"|wIum[ [>*^j+x6>#z?u1GZ7}B[_YiocRs4V/08Ygnd}lU0g0.kFl8La	<p,%0\o0iaC'[s/g~"3bN3 }jmjM~!~%5Cm)Oj/"IZk( E'?S%1J;M0FhwM)o_x.7zK=sSArC0	{yYtKDT$U[fM>	Q(JlbyO?{|:#^izsKom>vkm`q^ms=Xbpy~KZ
/(#.z(qUVU"tZ??.jKE<N&xjx75UH'Z5?%mE:wG|)G hmgo::\w9_0|=?(4J4qh44_Ey>"bs-43,z"|wn[ xO.fmogM[?i3]Z%XkW[2+~|M 5Y|))Y^z#IN}UQ57P:3gy+K\k`R]cj0/rT*TQ4x)GRtp4a05JZy_R0qqZKEA{_9 .9yEktz&,?.aak=JHVuo}f2JO$_"eE5</1o5h~cc'{[MCOxG p b
?j?G\hz?Mvi[	?ZB8Ka|5~MS]9-cwoi{xG&o!&4=mlid6RR/=GV]U~g:VlSqX7S	q8zJUc
5#R+<:u7h8H1&"KB9f<EVax,C	(QJ*)NjT)o6>x>/5i_\.unKPMu{3lq&1_Ppz(
3& dZk~*82M-"Xi`cMQ%yLpBfa'|o|6k::nuJ!#YU,/G^9kVI?TIN*J)9EU%zB m:D F;|[Sjimh{Xe4Y^MlG$. L=+[([4M.;6RV+c,M-I/cH>s0EGhC|O<n&N]{bx!5kF}5iYz."brsl<0qFBqc:T{*nN?\_q~%o?T.s"pC+.<YK 9<#g=:u/QvDGr[cD$<=Jx_Rhp"r#~rkW%	[CJn(Pk8BkOE*P
0s.7JTR-T\oNMki9# zcp}k:Il.2!$Fa vC([?N:vv^Y$>q_3IJji5tuJF}nGg#3G]GB9!A0R gpY;YNrW8}."gc~h%8VDw nhy`pq^UyOVih2Uck ~[ sQ:!mzXE3~|[Y ?d:gJ;VVaCI\(wT7 h[1O$72Ks.ym?xo"hL*Jq6W`Id]~ xo
<a#wzW</{7vD	6R#F|VE	~%<M3uV3(39{!UO	K*{JM$N?l?K<j~_v7S?9"^+-e<&M>7ChE7_~|T1?f |cW[-cCU7'FAP1m4Q? ST_Eosm<1oxOW0O+ZHt{e^2L[-.7#0V  !_/o"oxwS_j77>$]q65V)mh_[u3I:o-K?h*bnpc0Y3eX|/ff:Y\U(G^ux|@Yu1pMEfx&Sxqdx!e5Kf<exE*oM;i}?6!OxOlG4:|Kx5.Ca,p];JxRW4V_ fO?g,;xFr|?nqBRK-4Rr"4w]<yy}5V{{stloSt.E[%Z;AlU +<R/Z	bKx'[6^XI6{G7mC<>c<WW:mYd11`i]_U9GSWg]2K<7px<6?	 i_omoXCGI Z7>'][<FiZ[^yVYNU`GBz_o%wQMOSm1[w|)ctv1{w<m;")a|V f|c*Go]_
m$p;x~Y5?dnU_mLybkjZg):	U(J_#=
>K1&+2x\^/[,C,f'YVpk4%^oxF'NzU?E=~<n=:-G _pI$e"7t?<}?pYZP_F \}:s8`  tW<	g>8])5Y-15Y%cqndm'Xqyv/	JjpQsv|YkdaG;jTPe<^-b]'xxKlml30H'8x
W[FKpGks>5Kc-nt/iBn#hdlcDzIqw	K{buqIgkQw,!Y<.t=kL$1rWoI	4mZlnb"]  &O.udz3V6i5pj<9V)JxAPMFfSfQV(M;QjX%N>a(|ac_+[3-;wY dG-0x'-/=j)Q;|v.}*Akk6\,vs*U^_~ K+;a+ZM;7nxJ[nIc%cjggGL%m;yx-!?h^ouwsOukgwH,to8u\	<3U"jG/|8~pUb!{=Xa|9=]aG(aB:XRt]J5VV)uAxV//> V6Pkolz/lBl'IU>%uU/[iG0G!Bn^D!H`!<si7=Zaxt;CZ/Gi&6iym%~+m k b!0h!6:;U-	Bk7vL#xhrs_eOBxoaQBt\iF
R=~-~a^J 5F^!Ntl}UrRSI#:~pxVOT[=<xoM>fO7oEkG CK}GW Khb~(Zc|TI-.'JRt;L'%Xq)sY"XwizQfomCU5;k\cT{KUn5X//.kiF9%Q^?yr}{|xSo h*9}IRS]Snr)wg.w>3*4K(G
i*tRjbnbxLj>oMG8TNPPy<a[%Zr|?bKm~U\(s_|B 0s_KFOH8w<bs^G9nM=%o3s</:sBrSNq(R.h  	B<sn2.g 9kv ,z 	af \}0pu 8O[dds{ _	8:TVVIT7Q)rmq&+6WVYIPJ0RaFMF1J99Z	<dO|WxvEs`1z/\q!#a*z#= ]d:$,}959G*UQpS	ZT\2kRv. #
#
J!)F5)5Q&8+=O+.K	IYp$ wj<O_|Ww {V`Y$	H %?Ls_4+SUUI f*N1t5Teb
)_owu?pN
OGU0'7+_YJoUv[k}_|<k701;d`q|yn5|64r)a+wDr0{N+]~qO_H9c9<xW  Cs$Wq{zZ438GU,s#}8_P+(=WV?4~^ZyjXf%)v0."t!2@|s4rp@p @$|IKYGF, ;$g~s^c*#C'2s#6ObeKM2N'e~X'kR&ttZ+s^MRI%t_<jk)Z $HY8w {I'Z.YX*$'*szrI<p#XwB8ZcWivT.XzhYn{6v[XMGDO9Y6>P m99q  ` G|>	Vg~0Ufif5gEP!=e?9Y;K} `>p@H}zWtTjN#(KVj44gy8gErRkTtfI{ Cv:_<Jm~sAx:|$|:sis^Ag$O5ChoK~oOm# R%<1{=T\`u5WI$$sC<.K6D*,n"YH8 ~:~/.'$:l&)1x;N
#WKou[xYDPG 3`~7usf})8bJ	azKEGsA(rp|U.8lgjFno*Ig)F\S5!rpFy9|p1y95{[
_?w/
^\}SD[K-Vxx~k|g:\>|kio|/L
_"g	^8#Ry5;	lbTex?j{7SF^^U#R1&^.3K;T\Cf6''r(IYP]HrSG08 zuhier\ 2wgn1 ~LwY$3P9"Nzi-OH!yOvE$QBNeMuU5;[+d\YIKqo\VG<qFiX$i#'-THtB++WY%B9"x72|ok{A.o6H3$EHU'HkMVS[{VKuBHUS(DiM;k9f6QU~&W:4J(,!'Ru%//:8?c$3^;NOx49+*~ Sxvps:fz-Yj\XiZ?.u}sQNZEqu}{=%A.XbPc] 1k?>_|=^')|m6@	|:>$2wf50_	-j kIGZoS+MV1IO-2xCv7#G{i/5't':]?^WqqHP/i=TUgB.cYZMYTlLr'Fu%+ES~_|+X~?	|,zx2MwL/3uBH250_i	i 
j	a
i_%C{oI[WS$xuuw{.uq2]JI-O] H jX{^;_h>Q0gkjpu^k4GiqgficP:r0AU|1~x6b&FjNrT):TiJS:qg*^cqMzoajYe*Y}:SVq+(e^8B8Q_k|K>~%Vky B`ZM.Y|$bOT3'@\|P?  t`lW?]JQQ"akLb R6i@s_mcxk7Jxz40UcB)$a4JvzN0EN)%I)8XnH9ztQ<=}0;:?:q>=8{ c[p1$yWWk]\MfkW{CHF8x VE7#&2^= \W!6cF}Cuwg.9~fzrxg}4~bP4q4;z(=yWu%]"U 'qw1]p89l  gGw,&c^pP}Q8(b+&}*SN|	?N8?_|nmDH;f#8@^=+\ts}:uy$e%#X	OA|_|`9:sSwvzj}7 `#g?i&vGEXNN?  U'!s\9*Ecq\T\xy.qgx_e+^j4H~m"{ o#_9	//O^xc41-iN	8
FO1Xev>'_x#%@X$<-2[
_o|3;-Z{CV%,?e)diNKv%0f.s)^Ee(B)9'+E=l>qby9#p|Yp,$p=	==UX28e`F$pr1<t_8?@}k1rMu[+Zt>c'{7$]"L` c]R@!1=}p>r9>^[f1rB/%~rwkgmX4c+//i=ovQwoFl]eG8y9rq'R!fa W =DWP;'\sW!~r#>mitK|*F6kK(V{NEngnus\aAkI=H ~N}<fdP1<*nxIYmo<Z=SjMz?fzwIzwR/v%Im':, u+	fs]?F<O>2:u.dM-FEEOz62(k]xl\4:J$;O6x 9 8>q?j%OzKt~*(bL>/RTq4c*uN==YI~&Gx"`KjcZHR"s d~##T$q## KGG 3|vo";Zq"v?}8[\[2 sk+?k jFx{%oO&k@gjw^Rn)!DhZEbO _SL|~m?lKV~@lP|:<=t.~S5I\[kz/@# Nw~v?}7hXzw=<&Sa{H5t|[{9giN(|_vRY#VviJ)?__^.Og'|sMwm{e}-$mHeR;~* Cx#Y+(^9'sq`5 ,@%
 $ 5:c:>Bk=ii#g/}
Zow28"2pg -*LNsw,1=ZM>i/N%*Z>&'G_qC'rWzxR_SS:KGZ
30Gl?t'(0r7r/I0>^ \~oXEty3T84#--vZ#Z7n54[T+ee^I5*L`;9) P4/^1lt]^/(,l3X`y/Fg"\3arl/bkQsY&?<45'-\U9Qt8WBUI.+\a_arNe8x8*Q:W?< jw1`*"W;,$bJ<(|i)_i E_*Tt@ c_x:?%v=i>}M"1Oo&n.mKa4h%nz+C9s>8U_rN'iY&qJ9b8M
x,zjiTSJ<Srj0]O1?U}rUpx_fN5c8d5SzS p =yR:V#sp9\xsV-V?tObmu;,mMcpev>&D/j7vfjj/]}oS[lR"%xFURa8D*x_O	8<57f*8,=Lz8e
H0.O5tx2yW7<rAalR180)bkPGZXT~	 
Gt{l# .s:z~D@4n$b@Q*XRJ CkC%V8nomo&W<%QxZ =a_='(t27v}3_\)n-FOe*DX xy.ECnoYsZXJ6*q^a8<FS91K[/nkTe2G5S,Z18|nQ^Z:9fjh$:\a,n%dv2xH8VOV?x =1cWzksm-S_r14wCml /kiM6\7"&lKwqJ7j:xY#3	f8S<UYY~6TI	Thx|bs;j9dEHXJxxe0F7(HN/BIJS_JnSky&S|&wth@+eMM-Zz~M[jfn~e+VKcm7zxInW.5d]`*4AY-[.,9WNCyM
;(hS5*k|$cc'?H[A<2YB:yuR*6n]ek(Co.y"Q`<qyd<Q~elxqQt q|?xJTo[	,khN_CQ$Q\gn=Z
xDhw!|1m*}OJtVZ()nbM'p~ xcb8boKJzYOea0^n\SK8UKVy
u+MPu(=UN)Ft:`gLl0$q\W/`%B!>HgZci5_nm{BISJKwf,&\$y 4k
K]jzYYoX -<R[[4Ahf<0ckPpst)bLjZXB9(>5\U 5JX\.'GFL6;pt))<>65{XE~43#4ar<IZ]IcLG*c9Lr~oi}A [y< rpA<x @z]iz%0]m>v|3_\%R:[[l"Q7cJ0rAn!YoeGkbSf6[K|$aC@licY5x)ek:U\!aGR8.-_1s)009=lNarj8Zy<SGl5O`Z+O+9jc|;8;wxx"Nzpx>u xa$48:u8|xc[u]Gufk>Ru*~PN4Pg~x_|[oI </_ce`nr#Km=vKlms}*<w*8<, V SPt0/JQUfXcY#;7vK*'(WpV_PK:t$q`btr3V ]~S	+@=k
	WfJ/|-6 89}zEY7> AY|)mgx[J:i+.&"Ezj-VO%0[r0m\m4Knt4uD/K}_7wQF;U CSU^f%%xXr2 
qI_2 x;[9,)gK<5_Qqx5 \c
w Nr1 Ig)TO	`tWn=s =(h<{^L~6k p==_4y1W}}?$3n~$?|##=  ?nL
~#xC  89>{ 3'Y/Z^ivke_' jqo2.Z3yQ> i*ya2WSE  j 3? hF\:/F	GC6gYM>&2?cJ_az5
ZFm2iMOEPxiNbm;]uhR\c?J?O|{hEk:Oxovyc\-ZH-=F0EwIfolt?9t4 ;:<l/Wp8	2,0qSI{Ux9^gS98r.]Nie90u6OJ!K4W0f.*Kww>%K/tM/xHnL7zBH|i~O;O	u?O[3O/&Nn5-"-M[$aF|W{qt3qW#mG#K~Grq+d2FpNOS[&30a(Wa^c0,s>|3dGgIZL G6,+1=\6W`q9U\+qc=_R,_/59?E|Skagl/mo>LJXilQ0$Z<~azn{h:>hz~:+(KY2bY]' 5k5fEKICY6tx73LFeYMj%Z8]WL_\(ZTC7pGe&Mkf8aa~Q<cCB
|yO_t_'#D6;>ro$3!VRlYw>|JziboxEl-uXU|1ZR^X170I{c 	1M}h0XV#j7mm+hm"5H*]iAe~&G	L3G.m'Y6I<(u]/Z#>>WRy&O	csW0W6&J"u%IFJ>>W<aG,FKr_ c<-0
EfBX<5,<=k{-j/,~"xnM+Y|7yiucm(Fuu5E"o9?1xR_jZok3kZ/?i\yZ^KujwrCkmnZ|zR4	,;$m$JFR1+[GsyVdb%Zq F=/xY/_^
>c	<Y1SfX1yY"(Ub3LgUSNy.$x\E(K1
XZXY],Y~m`*h8caK>5$zq.uF[_Hyi=WC"_,<5=.;m'mrG7!q[g0&_0>,O.-f'CkHf8G`]>/:^ ,c22F,K8E9b\?08 Oe ]b0z[obe-	f9vkL5(`iUsHS*>{,e\XlS.d3>{O/VapJ*)Qua>}Dsk4xO(|Ehhh^"4C^o.d{5@<yh~,bSV0I|n2B>@V9<GB v:sa